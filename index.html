<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾ç·»é‹¼ç´ç®¡ç†ç³»çµ± Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        :root { --bg: #f8f9fa; --card: #ffffff; --primary: #5a67d8; --success: #48bb78; --danger: #f56565; --text: #2d3748; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 70px; }
        
        /* Tab Bar */
        nav { background: white; display: flex; justify-content: space-around; padding: 12px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        nav div { font-size: 14px; font-weight: 600; color: #a0aec0; cursor: pointer; transition: 0.3s; }
        nav div.active { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 4px; }

        .page { display: none; padding: 16px; max-width: 600px; margin: auto; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active-page { display: block; }

        /* Card Style */
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        h2, h3 { margin-top: 0; color: var(--primary); }
        
        /* Form elements */
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: #718096; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 16px; border: 1.5px solid #edf2f7; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        
        button { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-outline { background: white; color: var(--primary); border: 1.5px solid var(--primary); margin-top: 8px; }
        .btn-danger { background: var(--danger); }

        /* Calendar Adjustments */
        #calendar { background: white; padding: 10px; border-radius: 16px; border: 1px solid #edf2f7; height: 65vh; }
        .fc-event { cursor: pointer; border: none !important; padding: 2px 5px; }

        /* Modal Area */
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<nav id="navbar">
    <div onclick="showP('h', this)" class="active">ğŸ“… æ—¥æ›†</div>
    <div onclick="showP('s', this)">ğŸ‘¥ å­¸ç”Ÿ</div>
    <div onclick="showP('settings', this)">âš™ï¸ åœ/åŠ èª²</div>
    <div onclick="showP('b', this)">ğŸ’° å¸³å–®</div>
</nav>

<div id="h" class="page active-page">
    <div id="calendar"></div>
</div>

<div id="s" class="page">
    <button onclick="openSForm()">+ æ–°å¢å­¸ç”Ÿ</button>
    <div id="sList" style="margin-top:20px;"></div>
</div>

<div id="settings" class="page">
    <div class="card">
        <h3>å…¨å±€åœèª²/åŠ èª²è¨­å®š</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label>
        <select id="adjStudent"></select>
        <label>é¸æ“‡æ—¥æœŸ</label>
        <input type="date" id="adjDate">
        <label>é¡å‹</label>
        <select id="adjType">
            <option value="off">ğŸ”´ åœèª² (å„ªå…ˆç´šä½)</option>
            <option value="extra">ğŸŸ¢ åŠ èª² (å„ªå…ˆç´šé«˜)</option>
        </select>
        <button onclick="saveAdj()">å„²å­˜è®Šæ›´</button>
    </div>
    <div id="adjList"></div>
</div>

<div id="b" class="page">
    <div class="card">
        <label>å­¸ç”Ÿ</label><select id="bS" onchange="upB()"></select>
        <label>æœˆä»½</label><input type="month" id="bM" onchange="upB()">
        <label>æ•™æè²»</label><input type="number" id="bB" value="0" onchange="upB()">
    </div>
    <div class="card">
        <textarea id="bT" rows="8" style="background:#f1f5f9; border:none;"></textarea>
        <button onclick="share()" style="background:#00b900;">å‚³é€ LINE</button>
    </div>
</div>

<div id="modalOverlay">
    <div class="card" style="width:90%; max-width:400px;">
        <h3 id="formT">å­¸ç”Ÿè³‡è¨Š</h3>
        <input type="hidden" id="eIdx">
        <label>å§“å</label><input type="text" id="sN">
        <label>æ¯é€±ä¸Šèª²æ—¥</label>
        <select id="sD">
            <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option>
            <option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option>
        </select>
        <label>æ™‚é–“ (10åˆ†é˜ç‚ºå–®ä½)</label>
        <input type="time" id="sT" step="600">
        <label>å­¸è²»</label><input type="number" id="sR">
        <button onclick="saveS()">ç¢ºèªå„²å­˜</button>
        <button class="btn-outline" onclick="closeModal()">é—œé–‰</button>
        <button id="delBtn" class="btn-danger" style="margin-top:20px; display:none;">åˆªé™¤å­¸ç”Ÿ</button>
    </div>
</div>

<script>
    let ss = JSON.parse(localStorage.getItem('p_ss')) || [];
    let adjs = JSON.parse(localStorage.getItem('p_adjs')) || []; // {date, name, type}
    let cal;

    function fmtT(t) {
        if(!t) return "";
        let [h, m] = t.split(':');
        return (h >= 12 ? 'ä¸‹åˆ ' : 'ä¸Šåˆ ') + (h%12||12) + ':' + m;
    }

    function showP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        if(id === 'h') renderCal();
        if(id === 's') renderS();
        if(id === 'settings') renderAdj();
        if(id === 'b') upOpt();
    }

    function renderS() {
        document.getElementById('sList').innerHTML = ss.map((s, i) => `
            <div class="card">
                <div style="font-weight:bold; font-size:18px;">${s.n}</div>
                <div style="color:#718096; margin-bottom:10px;">é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.t)} | $${s.r}</div>
                <button onclick="openSForm(${i})" class="btn-outline">ä¿®æ”¹è³‡æ–™</button>
            </div>
        `).join('');
    }

    function openSForm(i) {
        document.getElementById('modalOverlay').style.display = 'flex';
        const delBtn = document.getElementById('delBtn');
        if(i != null) {
            document.getElementById('eIdx').value = i;
            document.getElementById('sN').value = ss[i].n;
            document.getElementById('sD').value = ss[i].d;
            document.getElementById('sT').value = ss[i].t;
            document.getElementById('sR').value = ss[i].r;
            delBtn.style.display = 'block';
            delBtn.onclick = () => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { ss.splice(i, 1); save(); closeModal(); } };
        } else {
            document.getElementById('eIdx').value = "";
            document.getElementById('sN').value = "";
            document.getElementById('sT').value = "14:00";
            delBtn.style.display = 'none';
        }
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function saveS() {
        let d = { n: document.getElementById('sN').value, d: document.getElementById('sD').value, t: document.getElementById('sT').value, r: document.getElementById('sR').value };
        let i = document.getElementById('eIdx').value;
        if(i === "") ss.push(d); else ss[i] = d;
        save(); closeModal();
    }

    function save() { 
        localStorage.setItem('p_ss', JSON.stringify(ss)); 
        localStorage.setItem('p_adjs', JSON.stringify(adjs));
        renderS(); 
    }

    function saveAdj() {
        let name = document.getElementById('adjStudent').value;
        let date = document.getElementById('adjDate').value;
        let type = document.getElementById('adjType').value;
        if(!date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        adjs.push({ name, date, type });
        save(); renderAdj();
    }

    function renderAdj() {
        document.getElementById('adjStudent').innerHTML = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
        document.getElementById('adjList').innerHTML = adjs.slice(-5).reverse().map((a, i) => `
            <div class="card" style="padding:10px; font-size:14px;">
                ${a.date} | ${a.name} | ${a.type==='off'?'ğŸ”´ åœèª²':'ğŸŸ¢ åŠ èª²'}
                <span onclick="adjs.splice(${adjs.length-1-i},1);save();renderAdj();" style="float:right; color:red;">åˆªé™¤</span>
            </div>
        `).join('');
    }

    function renderCal() {
        let el = document.getElementById('calendar');
        if(cal) cal.destroy();
        let evs = [];
        ss.forEach(s => {
            for(let i = -14; i < 60; i++) {
                let d = new Date(); d.setDate(d.getDate() + i);
                let dateStr = d.toISOString().split('T')[0];
                if(d.getDay() == s.d) {
                    let adj = adjs.find(a => a.date === dateStr && a.name === s.n);
                    if(adj && adj.type === 'off') {
                        evs.push({ title: 'âŒ åœèª²: ' + s.n, start: dateStr, color: '#fed7d7', textColor: '#c53030' });
                    } else {
                        evs.push({ title: s.n + ' ' + fmtT(s.t), start: dateStr + 'T' + s.t, color: '#ebf8ff', textColor: '#2b6cb0' });
                    }
                }
            }
        });
        // åŠ å…¥ç¨ç«‹åŠ èª²
        adjs.filter(a => a.type === 'extra').forEach(a => {
            let sInfo = ss.find(x => x.n === a.name);
            evs.push({ title: 'â­ åŠ èª²: ' + a.name, start: a.date + 'T' + (sInfo?sInfo.t:'12:00'), color: '#c6f6d5', textColor: '#22543d' });
        });

        cal = new FullCalendar.Calendar(el, {
            initialView: 'dayGridMonth',
            events: evs,
            locale: 'zh-tw',
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            dateClick: function(info) {
                document.getElementById('adjDate').value = info.dateStr;
                showP('settings', document.querySelectorAll('nav div')[2]);
            }
        });
        cal.render();
    }

    function upOpt() {
        document.getElementById('bS').innerHTML = ss.map((s,i) => `<option value="${i}">${s.n}</option>`).join('');
        upB();
    }

    function upB() {
        let i = document.getElementById('bS').value; if(!ss[i] || !document.getElementById('bM').value) return;
        let s = ss[i], mStr = document.getElementById('bM').value, b = parseInt(document.getElementById('bB').value)||0;
        let d = new Date(mStr + "-01"), mon = d.getMonth(), count = 0, dates = [];
        while(d.getMonth() === mon) {
            let dStr = d.toISOString().split('T')[0];
            let adj = adjs.find(a => a.date === dStr && a.name === s.n);
            // é‚è¼¯ï¼šé€±ä¸Šèª²æ—¥ ä¸” éåœèª² OR é¡å¤–åŠ èª²
            if ((d.getDay() == s.d && (!adj || adj.type !== 'off')) || (adj && adj.type === 'extra')) {
                count++; dates.push((mon+1)+'/'+d.getDate());
            }
            d.setDate(d.getDate() + 1);
        }
        document.getElementById('bT').value = `ã€${s.n} ${mon+1}æœˆå­¸è²»æ˜ç´°ã€‘\næ™‚é–“ï¼šé€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.t)}\nä¸Šèª²æ—¥ï¼š${dates.join(', ')} (å…±${count}å ‚)\nå­¸è²»ï¼š$${s.r * count}\næ•™æè²»ï¼š$${b}\n----------------\nç¸½è¨ˆï¼š$${(s.r * count) + b}\nå†è«‹æ‚¨æ ¸å°ï¼Œè¬è¬ï¼`;
    }

    function share() { window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(document.getElementById('bT').value); }

    showP('h', document.querySelector('nav div'));
</script>
</body>
</html>
