<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¼ç´èª²ç¨‹ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <style>
        :root { --p: #5a67d8; --s: #48bb78; --d: #f56565; --bg: #f8fafc; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        nav { background: white; display: flex; justify-content: space-around; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        nav div { font-weight: bold; color: #a0aec0; cursor: pointer; padding: 5px 10px; font-size: 14px; }
        nav div.active { color: var(--p); border-bottom: 2px solid var(--p); }
        .page { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .active-p { display: block; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        label { display: block; font-size: 13px; font-weight: bold; margin: 10px 0 5px; color: #4a5568; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .time-row { display: flex; gap: 10px; align-items: center; }
        .time-preview { font-size: 13px; color: var(--p); font-weight: bold; margin-bottom: 5px; }
        button { background: var(--p); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-o { background: white; color: var(--p); border: 1.5px solid var(--p); }
        #calendar { background: white; padding: 10px; border-radius: 15px; height: 70vh; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        .range-btn { background: #edf2f7; color: #2d3748; text-align: center; border: 1.5px solid #e2e8f0; min-height: 45px; display: flex; align-items: center; justify-content: center; width: 100%; border-radius: 10px; }
        .adj-item { font-size: 14px; padding: 12px 0; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
        .month-chip { display: inline-block; padding: 10px 15px; margin: 5px; border-radius: 10px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .month-chip.selected { background: var(--p); color: white; border-color: var(--p); }
    </style>
</head>
<body>

<nav>
    <div onclick="showP('h',this)" class="active">ğŸ“… æ—¥æ›†</div>
    <div onclick="showP('s',this)">ğŸ‘¥ å­¸ç”Ÿ</div>
    <div onclick="showP('off',this)">ğŸš« åœ/åŠ èª²</div>
    <div onclick="showP('b',this)">ğŸ’° è²»ç”¨</div>
    <div onclick="showP('m',this)">âš™ï¸ ç®¡ç†</div>
</nav>

<div id="h" class="page active-p"><div id="calendar"></div></div>

<div id="s" class="page">
    <button onclick="openSForm()">+ æ–°å¢å­¸ç”Ÿæª”æ¡ˆ</button>
    <div id="sList" style="margin-top:15px;"></div>
</div>

<div id="off" class="page">
    <div class="card">
        <h3>ğŸ“¢ å…¨é«”åœèª²</h3>
        <button id="allRangeBtn" class="range-btn">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="allRangeVal">
        <label>åŸå› </label><input type="text" id="allReason" placeholder="ä¾‹ï¼šåœ‹å®šå‡æ—¥ã€è€å¸«è«‹å‡">
        <button class="btn-d" style="margin-top:10px;" onclick="addAdj('ALL', 'off', 'allRangeVal', 'allRangeBtn')">ç¢ºèªå…¨é«”åœèª²</button>
    </div>
    <div class="card">
        <h3>ğŸ‘¤ å€‹åˆ¥åœ/åŠ èª²</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="oneStudent" onchange="updateExRateHint(); resetOneFp();"></select>
        
        <label>é¡å‹</label>
        <select id="oneType" onchange="toggleAdjFields(this.value); resetOneFp();">
            <option value="off">ğŸ”´ åœèª²</option>
            <option value="extra">ğŸŸ¢ åŠ èª²</option>
        </select>
        
        <button id="oneRangeBtn" class="range-btn" style="margin-top:10px;">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="oneRangeVal">

        <div id="adjReasonArea">
            <label>åœèª²åŸå› </label>
            <input type="text" id="adjReason" placeholder="ä¾‹ï¼šæ„Ÿå†’è«‹å‡ã€å®¶ä¸­æœ‰äº‹">
        </div>
        <div id="extraTimeArea" style="display:none;">
            <label>åŠ èª²æ™‚æ®µ</label>
            <div class="time-row">
                <input type="time" id="exTs" value="14:00" oninput="updateTimePreviewMulti('exTs','exTe','exTPreview')">
                <span>è‡³</span>
                <input type="time" id="exTe" value="14:50" oninput="updateTimePreviewMulti('exTs','exTe','exTPreview')">
            </div>
            <div id="exTPreview" class="time-preview"></div>
            <label>å–®æ¬¡åŠ èª²è²»ç”¨</label>
            <input type="number" id="exRate">
        </div>
        <button style="margin-top:10px;" onclick="addAdj(document.getElementById('oneStudent').value, document.getElementById('oneType').value, 'oneRangeVal', 'oneRangeBtn')">ç¢ºèªè¨­å®š</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“‹ å…¨é«”åœèª²æ¸…å–®</h3>
        <div id="allAdjList"></div>
    </div>
    
    <div class="card">
        <h3>ğŸ“‹ å€‹åˆ¥è¨­å®šæ¸…å–®</h3>
        <label>ç¯©é¸å­¸ç”Ÿ</label>
        <select id="filterStudent" onchange="renderAdj()"></select>
        <div id="oneAdjList"></div>
    </div>
</div>

<div id="b" class="page">
    <div class="card">
        <label>å°è±¡</label><select id="bS" onchange="initBilling()"></select>
        <label>æœˆä»½ (å¤šé¸)</label><div id="monthPicker"></div>
        <label>æ•™æè²»</label><input type="number" id="bB" value="0" onchange="upB()">
        <textarea id="bT" rows="11" style="margin-top:15px; background:#f8fafc; font-size: 14px; border:none;"></textarea>
        <button class="btn-s" style="margin-top:10px;" onclick="share()">LINE åˆ†äº«æ˜ç´°</button>
    </div>
</div>

<div id="m" class="page">
    <div class="card">
        <h3>âš™ï¸ ç³»çµ±ç®¡ç†</h3>
        <label>è³‡æ–™å‚™ä»½</label>
        <button class="btn-o" onclick="exportData()">ğŸ’¾ ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ (.json)</button>
        <label style="margin-top:20px;">åŒ¯å…¥å‚™ä»½</label>
        <input type="file" id="importFile" accept=".json" style="font-size: 12px; padding:10px; border:1px dashed #ccc; width:100%; border-radius:10px;">
        <button class="btn-s" style="margin-top:10px;" onclick="importData()">ğŸ“‚ åŸ·è¡ŒåŒ¯å…¥</button>
        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
        <label style="color:var(--d);">å±éšªå€åŸŸ</label>
        <button class="btn-d" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<div id="sModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3>å­¸ç”Ÿè³‡æ–™</h3>
        <input type="hidden" id="eIdx">
        <label>å§“å</label><input type="text" id="sN" placeholder="è«‹è¼¸å…¥å§“å">
        <label>é€±å¹¾</label><select id="sD"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select>
        <label>ä¸Šèª²æ™‚æ®µ</label>
        <div class="time-row"><input type="time" id="sTs"><span>~</span><input type="time" id="sTe"></div>
        <div id="sTPreview" class="time-preview"></div>
        <label>å­¸è²»</label><input type="number" id="sR" placeholder="è«‹è¼¸å…¥å­¸è²»">
        <button onclick="saveS()">å„²å­˜</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3 id="mTitle"></h3><p id="mDateDesc" style="color: #5a67d8; font-weight: bold;"></p>
        <input type="hidden" id="mAdjIdx">
        <label>ç•¶å¤©æ™‚æ®µ</label>
        <div class="time-row"><input type="time" id="mTs" oninput="updateTimePreviewMulti('mTs','mTe','mTPreview')"><span>~</span><input type="time" id="mTe" oninput="updateTimePreviewMulti('mTs','mTe','mTPreview')"></div>
        <div id="mTPreview" class="time-preview"></div>
        <label>å­¸è²»</label><input type="number" id="mR">
        <button onclick="saveDayEx()">å„²å­˜ä¿®æ”¹</button>
        <button class="btn-d" id="btnDelDay" style="margin-top:10px;" onclick="delDayEx()">åˆªé™¤é€™èª²å ‚</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<div id="adjModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3>ç·¨è¼¯è¨­å®š</h3>
        <input type="hidden" id="adjEditIdx">
        <p id="adjEditTarget" style="font-weight: bold; color: var(--p);"></p>
        
        <label>æ—¥æœŸç¯„åœ</label>
        <button id="adjEditRangeBtn" class="range-btn">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="adjEditRangeVal">

        <div id="adjEditReasonArea">
            <label>åŸå› </label>
            <input type="text" id="adjEditReason">
        </div>

        <div id="adjEditExtraArea" style="display:none;">
            <label>åŠ èª²æ™‚æ®µ</label>
            <div class="time-row">
                <input type="time" id="adjEditTs" oninput="updateTimePreviewMulti('adjEditTs','adjEditTe','adjEditTPreview')">
                <span>è‡³</span>
                <input type="time" id="adjEditTe" oninput="updateTimePreviewMulti('adjEditTs','adjEditTe','adjEditTPreview')">
            </div>
            <div id="adjEditTPreview" class="time-preview"></div>
            <label>å–®æ¬¡åŠ èª²è²»ç”¨</label>
            <input type="number" id="adjEditRate">
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="saveAdjEdit()" style="flex:2;">å„²å­˜ä¿®æ”¹</button>
            <button class="btn-d" onclick="delAdjFromModal()" style="flex:1;">åˆªé™¤</button>
        </div>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let ss = JSON.parse(localStorage.getItem('p_ss')) || [];
    let adjs = JSON.parse(localStorage.getItem('p_adjs')) || [];
    let dayEx = JSON.parse(localStorage.getItem('p_dayEx')) || {};
    let selectedMonths = [], cal, curEditDate, curEditName;

    function getDStr(date) {
        let y = date.getFullYear();
        let m = String(date.getMonth() + 1).padStart(2, '0');
        let d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function fmtT(t) { if(!t) return ""; let [h,m] = t.split(':'); return (h>=12?'ä¸‹åˆ':'ä¸Šåˆ')+(h%12||12)+':'+m; }
    function updateTimePreviewMulti(sid, eid, target) {
        let s = document.getElementById(sid).value, e = document.getElementById(eid).value;
        document.getElementById(target).innerText = (s && e) ? `ç¢ºèªæ™‚æ®µï¼š${fmtT(s)} ~ ${fmtT(e)}` : "";
    }

    const fpConfig = { 
        mode: "range", locale: "zh_tw", dateFormat: "Y-m-d",
        onClose: function(dates, str, instance) { instance.element.innerText = str.replace(/ (è‡³|åˆ°) /g, " ~ ") || "ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ..."; }
    };
    let fpAll = flatpickr("#allRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('allRangeVal').value = str });
    let fpOne = flatpickr("#oneRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('oneRangeVal').value = str });
    let fpEdit = flatpickr("#adjEditRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('adjEditRangeVal').value = str });

    function resetOneFp() {
        const name = document.getElementById('oneStudent').value;
        const type = document.getElementById('oneType').value;
        const s = ss.find(x => x.n === name);
        fpOne.clear();
        document.getElementById('oneRangeBtn').innerText = "ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...";
        if (type === 'off' && s) {
            fpOne.set("enable", [ (date) => {
                let dStr = getDStr(date);
                let curWeekday = date.getDay();
                if (s.history && s.history.length > 0) {
                    let h = s.history.find(hist => dStr < hist.until);
                    if (h) return curWeekday === h.d;
                }
                return curWeekday === s.d;
            }]);
        } else {
            fpOne.set("enable", [ (date) => true ]);
        }
    }

    function showP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-p'));
        document.getElementById(id).classList.add('active-p');
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id === 'h') renderCal();
        if(id === 's') renderS();
        if(id === 'off') { upOpt(); renderAdj(true); updateExRateHint(); resetOneFp(); }
        if(id === 'b') { upOpt(); initBilling(); }
    }

    function save() {
        localStorage.setItem('p_ss', JSON.stringify(ss));
        localStorage.setItem('p_adjs', JSON.stringify(adjs));
        localStorage.setItem('p_dayEx', JSON.stringify(dayEx));
    }

    function renderS() {
        document.getElementById('sList').innerHTML = ss.map((s, i) => `
            <div class="card"><b>${s.n}</b> | é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.ts)}~${fmtT(s.te)} ($${s.r})
            <div style="display:flex; gap:8px; margin-top:10px;"><button class="btn-o" style="flex:1;" onclick="openSForm(${i})">ä¿®æ”¹è³‡æ–™</button>
            <button class="btn-d" style="flex:1;" onclick="delStudent(${i})">åˆªé™¤</button></div></div>`).join('');
    }

    function delStudent(i) {
        if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${ss[i].n}ã€ï¼Ÿ`)) {
            let name = ss[i].n;
            ss.splice(i,1);
            adjs = adjs.filter(a => a.target !== name);
            save(); renderS();
        }
    }

    function openSForm(i) {
        document.getElementById('sModal').style.display='flex';
        if(i!=null) {
            let s = ss[i]; document.getElementById('eIdx').value=i; document.getElementById('sN').value=s.n;
            document.getElementById('sD').value=s.d; document.getElementById('sTs').value=s.ts; document.getElementById('sTe').value=s.te; document.getElementById('sR').value=s.r;
        } else {
            document.getElementById('eIdx').value=""; document.getElementById('sN').value=""; 
            document.getElementById('sTs').value="14:00"; document.getElementById('sTe').value="14:50";
        }
        updateTimePreviewMulti('sTs','sTe','sTPreview');
    }

    function saveS() {
        let name = document.getElementById('sN').value.trim();
        let rate = document.getElementById('sR').value.trim();
        if (!name || !rate) return alert("è«‹å¡«å¯«å§“åèˆ‡å­¸è²»ï¼");
        let i = document.getElementById('eIdx').value;
        let today = getDStr(new Date());

        if(i==="") {
            ss.push({ n: name, d: parseInt(document.getElementById('sD').value), ts: document.getElementById('sTs').value, te: document.getElementById('sTe').value, r: rate, history: [] });
        } else {
            let old = ss[i];
            let newD = parseInt(document.getElementById('sD').value);
            let newTs = document.getElementById('sTs').value;
            let newTe = document.getElementById('sTe').value;

            if (old.ts !== newTs || old.te !== newTe || old.r !== rate || old.d !== newD) {
                if(!old.history) old.history = [];
                old.history.push({ d: old.d, ts: old.ts, te: old.te, r: old.r, until: today });
                
                // åŠŸèƒ½ä¿®æ­£ï¼šç²¾ç´°æ¸…ç†ä»Šæ—¥å¾Œçš„å€‹åˆ¥è¨­å®š
                let removedDetails = [];
                
                adjs = adjs.filter(a => {
                    if (a.target !== name || a.start < today) return true;

                    // 1. å€‹åˆ¥åœèª²ï¼šåŸæœ¬é‡å°èˆŠæ™‚æ®µçš„åœèª²ä¸€å¾‹ç§»é™¤
                    if (a.type === 'off') {
                        removedDetails.push(`${a.start} (åœèª²)`);
                        return false;
                    }

                    // 2. å€‹åˆ¥åŠ èª²ï¼šåªæœ‰ç•¶æ—¥æœŸèˆ‡æ–°ä¸Šèª²æ—¥ç›¸åŒä¸”æ™‚æ®µè¡çªæ™‚æ‰ç§»é™¤
                    if (a.type === 'extra') {
                        let dCheck = new Date(a.start);
                        if (dCheck.getDay() === newD) {
                            if ((newTs < a.te) && (a.ts < newTe)) {
                                removedDetails.push(`${a.start} (åŠ èª²è¡çª)`);
                                return false;
                            }
                        }
                    }
                    return true;
                });

                if (removedDetails.length > 0) {
                    alert(`ğŸ“¢ èª²ç¨‹è®Šæ›´é€šçŸ¥ï¼š\nç”±æ–¼å›ºå®šæ™‚æ®µä¿®æ”¹ï¼Œç³»çµ±å·²ç§»é™¤ä¸‹åˆ—å—å½±éŸ¿çš„è¨­å®šï¼š\n${removedDetails.join('\n')}`);
                }
            }
            ss[i] = { ...old, n: name, d: newD, ts: newTs, te: newTe, r: rate };
        }
        save(); renderS(); closeModal();
    }

    function toggleAdjFields(v) { document.getElementById('extraTimeArea').style.display = v==='extra'?'block':'none'; document.getElementById('adjReasonArea').style.display = v==='off'?'block':'none'; updateExRateHint(); }
    function updateExRateHint() {
        let name = document.getElementById('oneStudent').value;
        let s = ss.find(x => x.n === name);
        if(s) { document.getElementById('exRate').value = s.r; document.getElementById('exRate').placeholder = `é è¨­ï¼š$${s.r}`; }
        updateTimePreviewMulti('exTs','exTe','exTPreview');
    }

    function handleExtraOverlap(target, start, end) {
        let overlapOffs = adjs.filter(a => a.target === target && a.type === 'off' && (start <= a.end && a.start <= end));
        if (overlapOffs.length > 0) {
            let msg = overlapOffs.map(a => `${a.start}~${a.end}`).join('\n');
            adjs = adjs.filter(a => !(a.target === target && a.type === 'off' && (start <= a.end && a.start <= end)));
            alert(`ğŸ“¢ é€šçŸ¥ï¼šå·²è‡ªå‹•ç§»é™¤ä¸‹åˆ—æ—¥æœŸè¡çªçš„ã€Œå€‹åˆ¥åœèª²ã€è¨­å®šï¼š\n${msg}`);
        }
    }

    function checkAdjConflict(target, type, start, end, ts, te, excludeIdx = -1) {
        let conflict = adjs.find((a, idx) => {
            if (idx === excludeIdx) return false;
            let dateOverlap = (start <= a.end) && (a.start <= end);
            if (!dateOverlap) return false;
            if (type === 'extra') {
                if (a.target === target && a.type === 'extra') { if ((ts < a.te) && (a.ts < te)) return true; }
            } else {
                if ((target === 'ALL' && a.target === 'ALL') || (target !== 'ALL' && a.target === target)) return true;
            }
            return false;
        });
        if (!conflict && type === 'extra') {
            let s = ss.find(x => x.n === target);
            if (s) {
                let dCheck = new Date(start);
                let dEnd = new Date(end);
                while(dCheck <= dEnd) {
                    let dStr = getDStr(dCheck);
                    let isAllOff = adjs.some((a, idx) => idx !== excludeIdx && a.target === 'ALL' && dStr >= a.start && dStr <= a.end);
                    if (dCheck.getDay() === s.d && !isAllOff) {
                        if ((ts < s.te) && (s.ts < te)) return { msg: `${dStr} å·²æœ‰å›ºå®šèª²ç¨‹ (${s.ts}~${s.te})` };
                    }
                    dCheck.setDate(dCheck.getDate() + 1);
                }
            }
        }
        return conflict ? { msg: "æ­¤æ—¥æœŸå€é–“å·²æœ‰ç›¸è¡çªçš„è¨­å®š" } : null;
    }

    function addAdj(target, type, valId, btnId) {
        let val = document.getElementById(valId).value; if(!val) return alert("è«‹é¸æ“‡ç¯„åœ");
        let parts = val.replace(/ (è‡³|åˆ°) /g, "~").split("~");
        let start = parts[0].trim(), end = (parts[1]||parts[0]).trim();
        let ts = type==='extra'?document.getElementById('exTs').value:null;
        let te = type==='extra'?document.getElementById('exTe').value:null;
        let r = type==='extra'?document.getElementById('exRate').value:null;
        let reason = (type === 'off' || target === 'ALL') ? (target === 'ALL' ? document.getElementById('allReason').value : document.getElementById('adjReason').value) : "";
        if (type !== 'extra' && !reason.trim()) return alert("è«‹å¡«å¯«åŸå› ï¼");
        let conflict = checkAdjConflict(target, type, start, end, ts, te);
        if (conflict) return alert(`ğŸš« ç„¡æ³•æ–°å¢ï¼š${conflict.msg}`);
        if (type === 'extra') handleExtraOverlap(target, start, end);
        adjs.push({ target, type, start, end, ts, te, r, reason, createdAt: Date.now() });
        save(); renderAdj(); 
        document.getElementById(btnId).innerText="ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ..."; 
        document.getElementById('allReason').value = ""; document.getElementById('adjReason').value = "";
        document.getElementById('exTs').value = "14:00"; document.getElementById('exTe').value = "14:50";
        let s = ss.find(x => x.n === target);
        document.getElementById('exRate').value = s ? s.r : "";
        fpAll.clear(); fpOne.clear();
        updateTimePreviewMulti('exTs','exTe','exTPreview');
    }

    function openAdjEdit(idx) {
        let a = adjs[idx];
        const s = ss.find(x => x.n === a.target);
        document.getElementById('adjEditIdx').value = idx;
        document.getElementById('adjEditTarget').innerText = a.target === 'ALL' ? "ğŸ“¢ å…¨é«”åœèª²" : `ğŸ‘¤ ${a.target} (${a.type==='off'?'åœèª²':'åŠ èª²'})`;
        document.getElementById('adjEditRangeVal').value = a.start + (a.start !== a.end ? " ~ " + a.end : "");
        document.getElementById('adjEditRangeBtn').innerText = a.start + (a.start !== a.end ? " ~ " + a.end : "");
        if (a.target !== 'ALL' && a.type === 'off' && s) {
            fpEdit.set("enable", [ (date) => {
                let dStr = getDStr(date);
                let curWeekday = date.getDay();
                if (s.history && s.history.length > 0) {
                    let h = s.history.find(hist => dStr < hist.until);
                    if (h) return curWeekday === h.d;
                }
                return curWeekday === s.d;
            }]);
        } else {
            fpEdit.set("enable", [ (date) => true ]);
        }
        fpEdit.setDate([a.start, a.end]);
        if (a.type === 'extra') {
            document.getElementById('adjEditExtraArea').style.display = 'block';
            document.getElementById('adjEditReasonArea').style.display = 'none';
            document.getElementById('adjEditTs').value = a.ts;
            document.getElementById('adjEditTe').value = a.te;
            document.getElementById('adjEditRate').value = a.r;
            updateTimePreviewMulti('adjEditTs','adjEditTe','adjEditTPreview');
        } else {
            document.getElementById('adjEditExtraArea').style.display = 'none';
            document.getElementById('adjEditReasonArea').style.display = 'block';
            document.getElementById('adjEditReason').value = a.reason;
        }
        document.getElementById('adjModal').style.display = 'flex';
    }

    function saveAdjEdit() {
        let idx = parseInt(document.getElementById('adjEditIdx').value);
        let old = adjs[idx];
        let rangeStr = document.getElementById('adjEditRangeVal').value;
        let parts = rangeStr.replace(/ (è‡³|åˆ°) /g, "~").split("~");
        let start = parts[0].trim(), end = (parts[1]||parts[0]).trim();
        let ts = old.type==='extra'?document.getElementById('adjEditTs').value:null;
        let te = old.type==='extra'?document.getElementById('adjEditTe').value:null;
        let r = old.type==='extra'?document.getElementById('adjEditRate').value:null;
        let reason = old.type!=='extra'?document.getElementById('adjEditReason').value:null;
        if (old.type !== 'extra' && !reason.trim()) return alert("è«‹å¡«å¯«åŸå› ï¼");
        let conflict = checkAdjConflict(old.target, old.type, start, end, ts, te, idx);
        if (conflict) return alert(`ğŸš« ç„¡æ³•ä¿®æ”¹ï¼š${conflict.msg}`);
        if (old.type === 'extra') handleExtraOverlap(old.target, start, end);
        adjs[idx] = { ...old, start, end, ts, te, r, reason };
        save(); renderAdj(); renderCal(); closeModal();
    }

    function delAdjFromModal() { let idx = parseInt(document.getElementById('adjEditIdx').value); delAdjItem(idx); closeModal(); }

    function delAdjItem(idx) {
        let a = adjs[idx];
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨­å®šï¼Ÿ')) return;
        if (a.target === 'ALL') {
            let removedInfo = [];
            ss.forEach(s => {
                let dCheck = new Date(a.start);
                let dEnd = new Date(a.end);
                while(dCheck <= dEnd) {
                    let dStr = getDStr(dCheck);
                    if (dCheck.getDay() === s.d) {
                        let extras = adjs.filter(ex => ex.target === s.n && ex.type === 'extra' && dStr >= ex.start && dStr <= ex.end);
                        extras.forEach(extra => {
                            if ((extra.ts < s.te) && (s.ts < extra.te)) {
                                removedInfo.push(`${s.n} (${dStr} ${extra.ts}~${extra.te})`);
                                adjs = adjs.filter(item => item !== extra);
                            }
                        });
                    }
                    dCheck.setDate(dCheck.getDate() + 1);
                }
            });
            if (removedInfo.length > 0) { alert(`ğŸ“¢ ç§»é™¤å…¨é«”åœèª²é€šçŸ¥ï¼š\nå› æ¢å¾©å›ºå®šèª²ç¨‹ï¼Œä¸‹åˆ—æ—¥æœŸè¡çªçš„å€‹åˆ¥åŠ èª²å·²è‡ªå‹•ç§»é™¤ï¼š\n${removedInfo.join('\n')}`); }
        }
        adjs.splice(idx, 1);
        save(); renderAdj(); renderCal();
    }

    function renderAdj(resetFilter = false) {
        const filterEl = document.getElementById('filterStudent');
        if (resetFilter) {
            let optionsHtml = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
            filterEl.innerHTML = optionsHtml;
            if (!filterEl.value || filterEl.value === "ALL") { if (ss.length > 0) filterEl.value = ss[0].n; }
        }
        let filterName = filterEl.value;
        let sorted = [...adjs].sort((a, b) => b.start.localeCompare(a.start));
        let allHtml = sorted.filter(a => a.target === 'ALL').map(a => {
            let realIdx = adjs.indexOf(a);
            return `<div class="adj-item"><div><b>ğŸ“¢ å…¨é«”åœèª²</b> [${a.reason||''}]<br>${a.start} ~ ${a.end}</div>
            <div style="display:flex; gap:5px;"><button onclick="openAdjEdit(${realIdx})" style="width:60px;background:var(--p);font-size:12px;margin:0;padding:6px;">ç·¨è¼¯</button>
            <button onclick="delAdjItem(${realIdx})" style="width:60px;background:var(--d);font-size:12px;margin:0;padding:6px;">åˆªé™¤</button></div></div>`;
        }).join('');
        let oneHtml = sorted.filter(a => a.target === filterName).map(a => {
            let realIdx = adjs.indexOf(a);
            let info = (a.type==='off') ? `åœèª²:${a.reason||''}` : `åŠ èª² ${a.ts||''}~${a.te||''} $${a.r||''}`;
            return `<div class="adj-item"><div><b>ğŸ‘¤ ${a.target}</b> [${info}]<br>${a.start} ~ ${a.end}</div>
            <div style="display:flex; gap:5px;"><button onclick="openAdjEdit(${realIdx})" style="width:60px;background:var(--p);font-size:12px;margin:0;padding:6px;">ç·¨è¼¯</button>
            <button onclick="delAdjItem(${realIdx})" style="width:60px;background:var(--d);font-size:12px;margin:0;padding:6px;">åˆªé™¤</button></div></div>`;
        }).join('');
        document.getElementById('allAdjList').innerHTML = allHtml || '<p style="color:#999;font-size:12px;">å°šç„¡è¨­å®š</p>';
        document.getElementById('oneAdjList').innerHTML = oneHtml || '<p style="color:#999;font-size:12px;">å°šç„¡è¨­å®š</p>';
    }

    function renderCal() {
        if(cal) cal.destroy();
        let evs = [], now = new Date(), todayStr = getDStr(now);
        let startBound = new Date(now.getFullYear() - 1, now.getMonth(), 1);
        let endBound = new Date(now.getFullYear(), now.getMonth() + 4, 0); 
        let d = new Date(startBound);
        while(d <= endBound) {
            let dStr = getDStr(d);
            ss.forEach(s => {
                let extras = adjs.filter(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
                let isOneOff = adjs.find(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end);
                let ex = dayEx[dStr + "_" + s.n];
                if(!(ex && ex.deleted)) {
                    if(extras.length > 0) {
                        extras.forEach(extra => {
                            evs.push({ title:`â• ${s.n} ${fmtT(extra.ts)}`, start: dStr+'T'+extra.ts, color:'#c6f6d5', textColor:'#22543d', extendedProps:{name:s.n, date:dStr, rate:extra.r, ts:extra.ts, te:extra.te, adjIdx: adjs.indexOf(extra), isExtra: true} });
                        });
                    } 
                    let curWeekday = d.getDay();
                    let useTs = s.ts, useTe = s.te, useR = s.r, matched = false;
                    if (s.history && s.history.length > 0) {
                        let h = s.history.find(hist => dStr < hist.until);
                        if (h) { if (curWeekday === h.d) { useTs = h.ts; useTe = h.te; useR = h.r; matched = true; } }
                        else if (curWeekday === s.d) matched = true;
                    } else if (curWeekday === s.d) matched = true;
                    if (matched) {
                        if (isOneOff) evs.push({ title:`âŒ ${isOneOff.reason||'åœèª²'} (${s.n})`, start: dStr, color:'#fed7d7', textColor:'#c53030', extendedProps:{ name:s.n, date:dStr, isOff: true, adjIdx: adjs.indexOf(isOneOff) } });
                        else if (isAllOff) evs.push({ title:`ğŸš« ${isAllOff.reason||'å…¨é«”åœèª²'} (${s.n})`, start: dStr, color:'#fbb6ce', textColor:'#702459' });
                        else {
                            let finalTs = ex ? ex.ts : useTs, finalTe = ex ? ex.te : useTe, finalR = ex ? ex.r : useR;
                            evs.push({ title:`${s.n} ${fmtT(finalTs)}`, start: dStr+'T'+finalTs, color:'#ebf8ff', textColor:'#2b6cb0', extendedProps:{name:s.n, date:dStr, rate:finalR, ts:finalTs, te:finalTe, adjIdx: -1} });
                        }
                    }
                }
            });
            d.setDate(d.getDate()+1);
        }
        cal = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView:'dayGridMonth', locale:'zh-tw', events:evs, headerToolbar:{left:'prev,next', center:'title', right:'today'},
            eventContent:(arg)=>({ domNodes:[Object.assign(document.createElement('div'),{innerText:arg.event.title, style:'font-size:11px;padding:2px'})] }),
            eventClick:(info)=>{
                let p = info.event.extendedProps; if(!p || !p.name) return;
                if (p.isOff || p.isExtra) { openAdjEdit(p.adjIdx); } 
                else {
                    curEditDate=p.date; curEditName=p.name; document.getElementById('mTitle').innerText=p.name; document.getElementById('mDateDesc').innerText=p.date;
                    document.getElementById('mTs').value=p.ts; document.getElementById('mTe').value=p.te; document.getElementById('mR').value=p.rate;
                    document.getElementById('mAdjIdx').value=p.adjIdx; 
                    let todayStr = getDStr(new Date());
                    document.getElementById('btnDelDay').disabled = (p.date >= todayStr);
                    updateTimePreviewMulti('mTs','mTe','mTPreview'); document.getElementById('dayModal').style.display='flex';
                }
            }
        });
        cal.render();
    }

    function initBilling() {Â 
        selectedMonths=[]; document.getElementById('bB').value=0; document.getElementById('bT').value=""; 
        renderMonthPicker();Â 
        let nowStr = getDStr(new Date()).substring(0, 7);
        let chips = document.querySelectorAll('.month-chip');
        chips.forEach(chip => { if(chip.innerText === nowStr) toggleMonth(nowStr); });
    }
    function upOpt() {Â 
        let options = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
        document.getElementById('bS').innerHTML = options; document.getElementById('oneStudent').innerHTML = options;
    }
    function renderMonthPicker() {
        let n = document.getElementById('bS').value; if(!n) return;
        let s = ss.find(x => x.n === n); if(!s) return;
        let avMonths = new Set(), now = new Date();
        let d = new Date(now.getFullYear() - 1, now.getMonth(), 1);
        let end = new Date(now.getFullYear(), now.getMonth() + 4, 0);
        while(d <= end) {
            let dStr = getDStr(d);
            let isExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
            let curWeekday = d.getDay();
            let isMatch = isExtra;
            if (!isMatch) {
                if (s.history && s.history.length > 0) {
                    let h = s.history.find(hist => dStr < hist.until);
                    if (h && curWeekday === h.d) isMatch = true;
                    else if (!h && curWeekday === s.d) isMatch = true;
                } else if (curWeekday === s.d) isMatch = true;
            }
            if (isMatch) avMonths.add(dStr.substring(0, 7));
            d.setDate(d.getDate() + 1);
        }
        document.getElementById('monthPicker').innerHTML = Array.from(avMonths).sort().map(m => `<div class="month-chip ${selectedMonths.includes(m)?'selected':''}" onclick="toggleMonth('${m}')">${m}</div>`).join('');
        upB();
    }
    function toggleMonth(m) { if(selectedMonths.includes(m)) selectedMonths = selectedMonths.filter(x => x !== m); else selectedMonths.push(m); renderMonthPicker(); }
    function upB() {
        let n = document.getElementById('bS').value; if(!n || selectedMonths.length === 0) { document.getElementById('bT').value = ""; return; }
        let s = ss.find(x => x.n === n), b = parseInt(document.getElementById('bB').value)||0, tCount=0, tR=0, monthLines=[], todayStr = getDStr(new Date());
        selectedMonths.sort().forEach(mStr => {
            let d = new Date(mStr + "-01"), mon = d.getMonth(), dayList = [];
            while(d.getMonth() === mon) {
                let dStr = getDStr(d);
                let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end), isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end), extras = adjs.filter(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end), ex = dayEx[dStr + "_" + s.n];
                extras.forEach(extra => { if (!(ex && ex.deleted)) { tCount++; tR += parseInt(extra.r); dayList.push(`${d.getDate()}æ—¥(${fmtT(extra.ts)}~${fmtT(extra.te)} $${parseInt(extra.r).toLocaleString()})`); } });
                let curWeekday = d.getDay();
                let useTs = null, useTe = null, useR = null, matched = false;
                if (s.history) {
                    let h = s.history.find(hist => dStr < hist.until);
                    if (h && curWeekday === h.d) { useTs = h.ts; useTe = h.te; useR = h.r; matched = true; }
                    else if (!h && curWeekday === s.d) { useTs = s.ts; useTe = s.te; useR = s.r; matched = true; }
                } else if (curWeekday === s.d) { useTs = s.ts; useTe = s.te; useR = s.r; matched = true; }
                if (matched && !isAllOff && !isOneOff && !(ex && ex.deleted)) {
                    let finalTs = ex ? ex.ts : useTs, finalTe = ex ? ex.te : useTe, finalR = ex ? ex.r : useR;
                    tCount++; tR += parseInt(finalR);
                    if (finalTs !== useTs || finalTe !== useTe || finalR !== useR) { dayList.push(`${d.getDate()}æ—¥(${fmtT(finalTs)}~${fmtT(finalTe)} $${parseInt(finalR).toLocaleString()})`); } 
                    else { dayList.push(`${d.getDate()}æ—¥`); }
                }
                d.setDate(d.getDate() + 1);
            }
            if(dayList.length > 0) { let mNum = mStr.split('-')[1].replace(/^0+/, ''); monthLines.push(`${mNum}æœˆï¼š${dayList.join('ã€')}`); }
        });
        let monthTitle = selectedMonths.map(m => m.split('-')[0] + 'å¹´' + m.split('-')[1].replace(/^0+/, '') + 'æœˆ').join('ã€');
        document.getElementById('bT').value = `ğŸ¹ é‹¼ç´èª²è²»ç”¨æ˜ç´° - ${s.n}\n------------------------\næœˆä»½ï¼š${monthTitle}\nä¸Šèª²æ—¥æœŸï¼š\n${monthLines.join('\n')}\nå…± ${tCount} å ‚\n\nèª²ç¨‹è²»ç”¨ï¼š$${tR.toLocaleString()}\næ•™æè²»ç”¨ï¼š$${b.toLocaleString()}\n------------------------\nç¸½è¨ˆé‡‘é¡ï¼š$${(tR + b).toLocaleString()}\n\nå†éº»ç…©åŒ¯æ¬¾å¾Œé€šçŸ¥ï¼Œè¬è¬ï¼`;
    }
    function saveDayEx() {Â 
        let ts = document.getElementById('mTs').value, te = document.getElementById('mTe').value, r = document.getElementById('mR').value;
        let adjIdx = parseInt(document.getElementById('mAdjIdx').value);
        if(adjIdx !== -1 && adjs[adjIdx]) { adjs[adjIdx].ts = ts; adjs[adjIdx].te = te; adjs[adjIdx].r = r; }
        dayEx[curEditDate + "_" + curEditName] = { ts, te, r, deleted: false }; save(); renderCal(); closeModal();Â 
    }
    function delDayEx() { if(confirm('ç¢ºå®šåˆªé™¤é€™å ‚èª²ï¼Ÿ')){ let adjIdx = parseInt(document.getElementById('mAdjIdx').value); if(adjIdx !== -1 && adjs[adjIdx]) adjs.splice(adjIdx, 1); else dayEx[curEditDate+"_"+curEditName]={deleted:true}; save(); renderCal(); closeModal(); } }
    function exportData() { const blob = new Blob([JSON.stringify({ss, adjs, dayEx})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `piano_backup.json`; a.click(); }
    function importData() { const input = document.getElementById('importFile'); if(!input.files[0]) return alert("è«‹é¸æ“‡æª”æ¡ˆ"); const reader = new FileReader(); reader.onload = () => { try { const d = JSON.parse(reader.result); ss=d.ss||[]; adjs=d.adjs||[]; dayEx=d.dayEx||{}; save(); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(input.files[0]); }
    function clearAllData() { if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ") && confirm("æœ€å¾Œç¢ºèªï¼šæ­¤å‹•ä½œä¸å¯å¾©åŸï¼")) { localStorage.clear(); location.reload(); } }
    function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    function share() { window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(document.getElementById('bT').value); }
    showP('h');
</script>
</body>
</html>
