<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚æ•™å­¸èª²ç¨‹ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <style>
        :root { --p: #5a67d8; --s: #48bb78; --d: #f56565; --bg: #f8fafc; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        /* ä¿®æ”¹é» 1: å°è¦½åˆ— Flex è¨­å®šï¼Œå‚ç›´ç½®ä¸­ */
        nav { background: white; display: flex; justify-content: space-around; align-items: center; padding: 10px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 50px; }
        nav div { font-weight: bold; color: #a0aec0; cursor: pointer; padding: 5px 5px; font-size: 14px; text-align: center; }
        nav div.active { color: var(--p); border-bottom: 2px solid var(--p); }
        
        .page { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .active-p { display: block; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        label { display: block; font-size: 13px; font-weight: bold; margin: 10px 0 5px; color: #4a5568; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:disabled, select:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        
        .time-row { display: flex; gap: 10px; align-items: center; }
        .time-row input { flex: 1; width: auto; min-width: 0; }

        .time-preview { font-size: 13px; color: var(--p); font-weight: bold; margin-bottom: 5px; }
        button { background: var(--p); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-o { background: white; color: var(--p); border: 1.5px solid var(--p); }
        #calendar { background: white; padding: 10px; border-radius: 15px; height: 70vh; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        
        /* ä¿®æ”¹é» 2: æ›´åš´æ ¼çš„ CSS ç¢ºä¿å–®è¡Œé¡¯ç¤º */
        .range-btn { 
            background: #edf2f7; 
            color: #2d3748; 
            text-align: center; 
            border: 1.5px solid #e2e8f0; 
            min-height: 45px; 
            line-height: 43px; /* æ‰£é™¤é‚Šæ¡†çš„é«˜åº¦ï¼Œç¢ºä¿å‚ç›´ç½®ä¸­ */
            width: 100%; 
            border-radius: 10px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: block; 
            padding: 0 8px;
            font-size: 14px; /* ç¸®å°ä¸€é»å­—é«”é¿å…å¤ªæ“  */
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .range-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .adj-item { font-size: 14px; padding: 12px 0; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
        .month-chip { display: inline-block; padding: 10px 15px; margin: 5px; border-radius: 10px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .month-chip.selected { background: var(--p); color: white; border-color: var(--p); }
    </style>
</head>
<body>

<nav>
    <div onclick="showP('h',this)" class="active">ğŸ“… æ—¥æ›†</div>
    <div onclick="showP('s',this)">ğŸ‘¥ å­¸ç”Ÿ</div>
    <div onclick="showP('off',this)" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
        <span style="font-size: 16px;">ğŸš«</span>
        <div style="font-size: 12px; line-height: 1.2; text-align: left;">å…¨é«”åœèª²<br>å€‹åˆ¥åŠ èª²</div>
    </div>
    <div onclick="showP('b',this)">ğŸ’° è²»ç”¨</div>
    <div onclick="showP('m',this)">âš™ï¸ ç®¡ç†</div>
</nav>

<div id="h" class="page active-p">
    <div class="card" style="padding: 15px;">
        <label style="margin-top:0;">ç¯©é¸é¡¯ç¤ºå­¸ç”Ÿ (æœªé¸å‰‡é¡¯ç¤ºå…¨éƒ¨)</label>
        <div id="calFilterArea"></div>
    </div>
    <div id="calendar"></div>
</div>

<div id="s" class="page">
    <button onclick="openSForm()">+ æ–°å¢å­¸ç”Ÿæª”æ¡ˆ (å›ºå®šèª²ç¨‹)</button>
    <div id="sList" style="margin-top:15px;"></div>
</div>

<div id="off" class="page">
    <div class="card">
        <h3>ğŸ“¢ å…¨é«”åœèª²</h3>
        <p style="font-size:12px; color:#718096; margin-bottom:10px;">å½±éŸ¿æ‰€æœ‰å›ºå®šèª²ç¨‹ï¼Œä¸å½±éŸ¿å€‹åˆ¥åŠ èª²</p>
        <button id="allRangeBtn" class="range-btn">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="allRangeVal">
        <label>åŸå› </label><input type="text" id="allReason" placeholder="ä¾‹ï¼šè–èª•ç¯€">
        <button class="btn-d" style="margin-top:10px;" onclick="addAdj('ALL', 'off', 'allRangeVal', 'allRangeBtn')">ç¢ºèªå…¨é«”åœèª²</button>
    </div>
    <div class="card">
        <h3>ğŸŸ¢ å€‹åˆ¥åŠ èª²</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="oneStudent" onchange="resetOneFp();"></select>
        <button id="oneRangeBtn" class="range-btn" style="margin-top:10px;">ğŸ“… é»æ“Šé¸æ“‡...</button>
        <input type="hidden" id="oneRangeVal">
        <div id="extraTimeArea">
            <label>åŠ èª²æ™‚æ®µ</label>
            <div class="time-row">
                <input type="time" id="exTs" value="14:00" oninput="onTimeChange(true, 'exTs', 'exTe', 'exTPreview')">
                <span>è‡³</span>
                <input type="time" id="exTe" value="14:50" oninput="onTimeChange(false, 'exTs', 'exTe', 'exTPreview')">
            </div>
            <div id="exTPreview" class="time-preview"></div>
            <label>å–®æ¬¡åŠ èª²è²»ç”¨</label>
            <input type="number" id="exRate">
        </div>
        <button style="margin-top:10px;" onclick="addAdj(document.getElementById('oneStudent').value, 'extra', 'oneRangeVal', 'oneRangeBtn')">ç¢ºèªåŠ èª²</button>
    </div>
    <div class="card">
        <h3>ğŸ“‹ å…¨é«”åœèª²æ¸…å–®</h3>
        <div id="allAdjList"></div>
    </div>
    <div class="card">
        <h3>ğŸ“‹ å€‹åˆ¥åŠ èª²æ¸…å–®</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label>
        <select id="filterStudent" onchange="renderAdj()"></select>
        <div id="oneAdjList"></div>
    </div>
</div>

<div id="b" class="page">
    <div class="card">
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="bS" onchange="initBilling()"></select>
        <label>æœˆä»½ (å¤šé¸)</label><div id="monthPicker"></div>
        <label>æ•™æè²»</label><input type="number" id="bB" value="0" onchange="upB()">
        <textarea id="bT" rows="11" style="margin-top:15px; background:#f8fafc; font-size: 14px; border:none;"></textarea>
        <button class="btn-s" style="margin-top:10px;" onclick="share()">LINE åˆ†äº«æ˜ç´°</button>
    </div>
</div>

<div id="m" class="page">
    <div class="card">
        <h3>âš™ï¸ ç³»çµ±ç®¡ç†</h3>
        <button class="btn-o" onclick="exportData()">ğŸ’¾ ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ (.json)</button>
        <label style="margin-top:20px;">åŒ¯å…¥å‚™ä»½</label>
        <input type="file" id="importFile" accept=".json" style="font-size: 12px; padding:10px; border:1px dashed #ccc; width:100%; border-radius:10px;">
        <button class="btn-s" style="margin-top:10px;" onclick="importData()">ğŸ“‚ åŸ·è¡ŒåŒ¯å…¥</button>
        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
        <button class="btn-d" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<div id="sModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3>å­¸ç”Ÿè³‡æ–™ (å›ºå®šèª²ç¨‹)</h3>
        <p id="sEditHint" style="font-size:12px; color:#b7791f; background:#fffff0; padding:8px; border-radius:5px; margin-bottom:15px; display:none; border:1px solid #f6e05e;">
            âš ï¸ ä¿®æ”¹åƒ…å½±éŸ¿æœªä¾†(å«ä»Šæ—¥)çš„èª²ç¨‹ï¼Œä¸æº¯åŠæ—¢å¾€ã€‚
        </p>
        <input type="hidden" id="eIdx">
        <label>å§“å</label><input type="text" id="sN" placeholder="è«‹è¼¸å…¥å§“å">
        <label>é€±å¹¾</label><select id="sD"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select>
        <label>ä¸Šèª²æ™‚æ®µ</label>
        <div class="time-row">
            <input type="time" id="sTs" oninput="onTimeChange(true, 'sTs', 'sTe', 'sTPreview')">
            <span>~</span>
            <input type="time" id="sTe" oninput="onTimeChange(false, 'sTs', 'sTe', 'sTPreview')">
        </div>
        <div id="sTPreview" class="time-preview"></div>
        <label>å­¸è²»</label><input type="number" id="sR" placeholder="è«‹è¼¸å…¥å­¸è²»">
        <button onclick="saveS()" style="margin-top:20px;">å„²å­˜</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3 id="mTitle"></h3>
        <p id="mDateDesc" style="color: #5a67d8; font-weight: bold;"></p>
        <input type="hidden" id="mOrigDate"> <label>èª²å ‚ç‹€æ…‹</label>
        
        <select id="mStatus" onchange="updateDayModalUI(false)"></select>

        <div id="mOffReasonArea">
            <label>åœèª²åŸå› </label>
            <input type="text" id="mOffReason" placeholder="æ„Ÿå†’">
        </div>

        <div id="mDateArea">
            <label>ä¿®æ”¹æ—¥æœŸ (é™åŒé€±)</label>
            <button id="mDateBtn" class="range-btn">ğŸ“… é»æ“Šä¿®æ”¹æ—¥æœŸ</button>
            <input type="hidden" id="mDateVal">
        </div>

        <div id="mTimeArea">
            <label>ç•¶å¤©æ™‚æ®µ</label>
            <div class="time-row"><input type="time" id="mTs" oninput="onTimeChange(true, 'mTs', 'mTe', 'mTPreview')"><span>~</span><input type="time" id="mTe" oninput="onTimeChange(false, 'mTs', 'mTe', 'mTPreview')"></div>
            <div id="mTPreview" class="time-preview"></div>
            <label>å­¸è²»</label><input type="number" id="mR">
        </div>
        
        <button onclick="saveDayEx()" style="margin-top:20px;">å„²å­˜ä¿®æ”¹</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<div id="adjModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3 id="adjEditTarget"></h3>
        <input type="hidden" id="adjEditIdx">
        <label>æ—¥æœŸç¯„åœ</label>
        <button id="adjEditRangeBtn" class="range-btn">ğŸ“… é»æ“Šä¿®æ”¹æ—¥æœŸ</button>
        <input type="hidden" id="adjEditRangeVal">
        
        <div id="adjEditExtraArea">
            <label>æ™‚æ®µ</label>
            <div class="time-row"><input type="time" id="adjEditTs" oninput="onTimeChange(true, 'adjEditTs', 'adjEditTe', 'adjEditTPreview')"><span>~</span><input type="time" id="adjEditTe" oninput="onTimeChange(false, 'adjEditTs', 'adjEditTe', 'adjEditTPreview')"></div>
            <div id="adjEditTPreview" class="time-preview"></div>
            <label>è²»ç”¨</label><input type="number" id="adjEditRate">
        </div>

        <div id="adjEditReasonArea">
            <label>åŸå› </label><input type="text" id="adjEditReason">
        </div>
        
        <button onclick="saveAdjEdit()" style="margin-top:20px;">å„²å­˜ä¿®æ”¹</button>
        <button class="btn-d" style="margin-top:10px;" onclick="delAdjFromModal()">åˆªé™¤è¨­å®š</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let ss = JSON.parse(localStorage.getItem('p_ss')) || [];
    let adjs = JSON.parse(localStorage.getItem('p_adjs')) || [];
    let dayEx = JSON.parse(localStorage.getItem('p_dayEx')) || {};
    let selectedMonths = [], cal, curEditName;
    let tempNormalValues = { ts: "", te: "", r: "" };
    let calFilterNames = [];

    function sortSS() {
        ss.sort((a, b) => {
            let da = a.d === 0 ? 7 : a.d;
            let db = b.d === 0 ? 7 : b.d;
            if (da !== db) return da - db;
            return a.ts.localeCompare(b.ts);
        });
    }

    sortSS();

    function getDStr(date) {
        let y = date.getFullYear();
        let m = String(date.getMonth() + 1).padStart(2, '0');
        let d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function fmtT(t) { 
        if(!t) return ""; 
        let [h, m] = t.split(':'); 
        let hNum = parseInt(h); 
        return (hNum >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ') + (hNum % 12 || 12) + ':' + m; 
    }

    function onTimeChange(isStart, idS, idE, idPreview) {
        adjustTimeAuto(isStart, idS, idE);
        updateTimePreviewMulti(idS, idE, idPreview);
    }

    function adjustTimeAuto(isStart, idS, idE) {
        let sVal = document.getElementById(idS).value;
        let eVal = document.getElementById(idE).value;
        if(!sVal || !eVal) return;

        let sDate = new Date(`2000-01-01T${sVal}`);
        let eDate = new Date(`2000-01-01T${eVal}`);

        if (isStart) {
            if (sDate >= eDate) {
                sDate.setMinutes(sDate.getMinutes() + 50);
                let h = String(sDate.getHours()).padStart(2,'0');
                let m = String(sDate.getMinutes()).padStart(2,'0');
                document.getElementById(idE).value = `${h}:${m}`;
            }
        } else {
            if (eDate <= sDate) {
                eDate.setMinutes(eDate.getMinutes() - 50);
                let h = String(eDate.getHours()).padStart(2,'0');
                let m = String(eDate.getMinutes()).padStart(2,'0');
                document.getElementById(idS).value = `${h}:${m}`;
            }
        }
    }

    function updateTimePreviewMulti(sid, eid, target) {
        let s = document.getElementById(sid).value, e = document.getElementById(eid).value;
        document.getElementById(target).innerText = (s && e) ? `ç¢ºèªæ™‚æ®µï¼š${fmtT(s)} ~ ${fmtT(e)}` : "";
    }

    const fpConfig = { 
        mode: "range", locale: "zh_tw", dateFormat: "Y-m-d",
        onClose: function(dates, str, instance) { instance.element.innerText = str.replace(/ (è‡³|åˆ°) /g, " ~ ") || "ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ..."; }
    };
    let fpAll = flatpickr("#allRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('allRangeVal').value = str });
    let fpOne = flatpickr("#oneRangeBtn", { ...fpConfig, mode: "single", onChange: (d, str) => document.getElementById('oneRangeVal').value = str });
    let fpEdit = flatpickr("#adjEditRangeBtn", { ...fpConfig, dateFormat: "Y-m-d", onChange: (d, str) => document.getElementById('adjEditRangeVal').value = str });
       
    let fpDateEdit = flatpickr("#mDateBtn", {
        locale: "zh_tw", dateFormat: "Y-m-d",
        disableMobile: true, 
        onChange: (d, str) => {
            document.getElementById('mDateVal').value = str;
            updateDayModalUI(true);
        },
        onClose: function(dates, str, instance) { instance.element.innerText = str || "ğŸ“… é»æ“Šä¿®æ”¹æ—¥æœŸ"; }
    });

    function resetOneFp() {
        const name = document.getElementById('oneStudent').value;
        const now = new Date();
        const maxD = new Date(now.getFullYear(), now.getMonth() + 12, 0);
        fpOne.clear();
        document.getElementById('oneRangeBtn').innerText = "ğŸ“… é»æ“Šé¸æ“‡...";
        fpOne.set("minDate", null); 
        fpOne.set("maxDate", maxD);
        
        let s = ss.find(x => x.n === name);
        if(s) {
            document.getElementById('exRate').value = s.r;
            document.getElementById('exTs').value = s.ts;
            document.getElementById('exTe').value = s.te;
            updateTimePreviewMulti('exTs','exTe','exTPreview');
        }
    }

    function showP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-p'));
        document.getElementById(id).classList.add('active-p');
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        if(el) {
            // nav div æœ¬èº«è¢«é»æ“Šï¼Œå¦‚æœæ˜¯é‚£å€‹ç‰¹æ®Šçš„ divï¼ŒelæœƒæŒ‡å‘div
            // å› ç‚ºçµæ§‹æ”¹è®Šï¼Œè‹¥ el æ˜¯å…§éƒ¨å…ƒä»¶å¯èƒ½éœ€è¦å‘ä¸Šæ‰¾ï¼Œä½†é€™è£¡ç›´æ¥å‚³ this æ‡‰è©²æ˜¯ div
            // ç”±æ–¼æ”¹æˆäº† flex containerï¼Œç‚ºäº†ç¢ºä¿ active class æ¨£å¼æ­£ç¢ºï¼Œ
            // è‹¥å‚³å…¥çš„æ˜¯å…§éƒ¨å…ƒç´ ï¼Œå¯èƒ½éœ€è¦èª¿æ•´ CSSï¼Œä½†é€™è£¡ nav div.active é¸æ“‡å™¨æ‡‰è©²é‚„èƒ½é‹ä½œ
            // å› ç‚º onclick æ˜¯ç¶åœ¨ parent div ä¸Š
            el.classList.add('active');
        }
        if(id === 'h') { renderCalFilter(); renderCal(); }
        if(id === 's') renderS();
        if(id === 'off') { 
            upOpt(); 
            renderAdj(true); 
            resetOneFp(); 
            document.getElementById('allRangeVal').value = "";
            document.getElementById('allRangeBtn').innerText = "ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...";
            fpAll.clear();
        }
        if(id === 'b') { upOpt(); initBilling(); }
    }

    function save() {
        localStorage.setItem('p_ss', JSON.stringify(ss));
        localStorage.setItem('p_adjs', JSON.stringify(adjs));
        localStorage.setItem('p_dayEx', JSON.stringify(dayEx));
    }

    function renderS() {
        document.getElementById('sList').innerHTML = ss.map((s, i) => `
            <div class="card"><b>${s.n}</b> | é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.ts)}~${fmtT(s.te)} ($${s.r})
            <div style="display:flex; gap:8px; margin-top:10px;"><button class="btn-o" style="flex:1;" onclick="openSForm(${i})">ä¿®æ”¹è³‡æ–™</button>
            <button class="btn-d" style="flex:1;" onclick="delStudent(${i})">åˆªé™¤</button></div></div>`).join('');
    }

    function delStudent(i) {
        if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${ss[i].n}ã€ï¼Ÿ`)) { 
            let name = ss[i].n;
            ss.splice(i,1);
            adjs = adjs.filter(a => a.target !== name);
            calFilterNames = calFilterNames.filter(n => n !== name);
            save(); renderS();
        }
    }

    function openSForm(i) {
        document.getElementById('sModal').style.display='flex';
        let hintEl = document.getElementById('sEditHint');
        
        if(i!=null) {
            hintEl.style.display = 'block';
            let s = ss[i]; document.getElementById('eIdx').value=i; document.getElementById('sN').value=s.n;
            document.getElementById('sD').value=s.d; document.getElementById('sTs').value=s.ts; document.getElementById('sTe').value=s.te; document.getElementById('sR').value=s.r;
        } else {
            hintEl.style.display = 'none';
            document.getElementById('eIdx').value=""; document.getElementById('sN').value=""; 
            document.getElementById('sTs').value="14:00"; document.getElementById('sTe').value="14:50";
            document.getElementById('sR').value="1000";
        }
        updateTimePreviewMulti('sTs','sTe','sTPreview');
    }

    function saveS() {
        let name = document.getElementById('sN').value.trim();
        let rate = document.getElementById('sR').value.trim();
        let wd = parseInt(document.getElementById('sD').value);
        let ts = document.getElementById('sTs').value;
        let te = document.getElementById('sTe').value;

        if (!name || !rate) return alert("è«‹å¡«å¯«å§“åèˆ‡å­¸è²»ï¼"); 
        let i = document.getElementById('eIdx').value;
        
        let editIndex = (i === "") ? -1 : parseInt(i);
        
        let duplicate = ss.find((s, idx) => s.n === name && idx !== editIndex);
        if (duplicate) return alert("æ­¤å­¸ç”Ÿå§“åå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒåç¨±ï¼"); 

        let now = new Date();
        let todayStr = getDStr(now);
        let firstDayOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        let firstDayStr = getDStr(firstDayOfCurrentMonth);

        let timeConflict = checkTimeConflict(name, wd, ts, te, i);
        if (timeConflict) return alert(`ğŸš« æ™‚æ®µè¡çªï¼š\nèˆ‡å­¸ç”Ÿ ${timeConflict.n} çš„æ™‚æ®µ (${fmtT(timeConflict.ts)}~${fmtT(timeConflict.te)}) é‡ç–Šï¼`); 

        if(i==="") {
            ss.push({ n: name, d: wd, ts: ts, te: te, r: rate, history: [], createdDate: firstDayStr });
        } else {
            let old = ss[i];
            
            if (old.ts !== ts || old.te !== te || old.r !== rate || old.d !== wd) {
                if(!old.history) old.history = [];
                old.history.push({ d: old.d, ts: old.ts, te: old.te, r: old.r, until: todayStr });
            }
            ss[i] = { ...old, n: name, d: wd, ts: ts, te: te, r: rate, createdDate: old.createdDate || firstDayStr };
            
            for (let key in dayEx) {
                if (key.includes(name)) {
                    let datePart = key.split('_')[0];
                    if (datePart >= todayStr) delete dayEx[key];
                }
            }
        }
        
        revalidateAndCleanExtras(todayStr);
        sortSS();
        save(); renderS(); closeModal();
    }

    function checkTimeConflict(name, wd, ts, te, selfIdx) {
        for (let idx = 0; idx < ss.length; idx++) {
            if (selfIdx !== "" && idx == selfIdx) continue; 
            let s = ss[idx];
            if (s.d === wd) {
                if ((ts < s.te) && (s.ts < te)) {
                    return s;
                }
            }
        }
        return null;
    }

    function getStudentStartDate(s) {
        if (s.createdDate) return new Date(s.createdDate);
        if (s.history && s.history.length > 0) return new Date(2000, 0, 1);
        let now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), 1); 
    }

    function getEffectiveLesson(studentName, dateStr) {
        let s = ss.find(x => x.n === studentName);
        if (!s) return null;

        let dObj = new Date(dateStr);
        let curWeekday = dObj.getDay();
        
        let startDate = getStudentStartDate(s);
        if (dObj < startDate) {
             return { status: 'none' };
        }

        let ex = dayEx[dateStr + "_" + studentName];
        let isGlobalOff = adjs.find(a => a.target === 'ALL' && dateStr >= a.start && dateStr <= a.end);

        let status = 'none';
        let ts = null, te = null;

        let baseTs = s.ts, baseTe = s.te;
        let isBaseDay = false;
        
        if (s.history) {
            let h = s.history.find(hist => dateStr < hist.until);
            if (h) {
                if (h.d === curWeekday) { baseTs = h.ts; baseTe = h.te; isBaseDay = true; }
            } 
            else if (s.d === curWeekday) { 
                isBaseDay = true; 
            }
        } 
        else if (s.d === curWeekday) { 
            isBaseDay = true; 
        }

        let effectiveTs = baseTs, effectiveTe = baseTe;
        if (ex && !ex.deleted) {
            isBaseDay = true; 
            if (ex.ts) effectiveTs = ex.ts;
            if (ex.te) effectiveTe = ex.te;
        } else if (ex && ex.deleted) {
            isBaseDay = false; 
        }

        if (!isBaseDay) return { status: 'none' };

        if (isGlobalOff) {
            status = 'global_off';
        } else if (ex && ex.status === 'off') {
            status = 'off';
        } else if (ex && ex.status === 'normal') {
            status = 'normal';
        } else {
            status = 'normal'; 
        }

        return { status, ts: effectiveTs, te: effectiveTe };
    }

    function checkAdjConflict(target, type, start, end, ts, te, excludeIdx = -1) {
        if (type === 'extra') {
            let extraConflict = adjs.find((a, idx) => {
                if (idx === excludeIdx) return false;
                if (a.target === target && a.type === 'extra') {
                    let dateOverlap = (start <= a.end) && (a.start <= end);
                    if (dateOverlap && ((ts < a.te) && (a.ts < te))) return true;
                }
                return false;
            });
            if (extraConflict) return { msg: "æ­¤æ™‚æ®µå·²æœ‰å…¶ä»–åŠ èª²" };

            let dCheck = new Date(start);
            let dEnd = new Date(end);
            
            while(dCheck <= dEnd) {
                let dStr = getDStr(dCheck);
                let lessonInfo = getEffectiveLesson(target, dStr);

                if (lessonInfo && lessonInfo.status === 'normal') {
                    if ((ts < lessonInfo.te) && (lessonInfo.ts < te)) {
                        return { msg: `${dStr} èˆ‡å›ºå®šèª²ç¨‹ (${lessonInfo.ts}~${lessonInfo.te}) è¡çª` };
                    }
                }
                dCheck.setDate(dCheck.getDate() + 1);
            }
        } else {
            if (target === 'ALL') {
                let conflict = adjs.find((a, idx) => {
                    if (idx === excludeIdx) return false;
                    if (a.target === 'ALL') {
                        return (start <= a.end) && (a.start <= end);
                    }
                    return false;
                });
                if (conflict) return { msg: "æ­¤æ—¥æœŸå€é–“å·²æœ‰å…¶ä»–å…¨é«”åœèª²è¨­å®š" };
            }
        }
        return null;
    }

    function revalidateAndCleanExtras(minDateStr = null) {
        let removedCount = 0;
        let removedDetails = [];

        for (let i = adjs.length - 1; i >= 0; i--) {
            let a = adjs[i];
            
            if (minDateStr && a.start < minDateStr) continue;

            if (a.type === 'extra') {
                let lessonInfo = getEffectiveLesson(a.target, a.start); 
                                
                if (lessonInfo && lessonInfo.status === 'normal') {
                    if ((a.ts < lessonInfo.te) && (lessonInfo.ts < a.te)) {
                        adjs.splice(i, 1);
                        removedCount++;
                        removedDetails.push(`${a.target} åœ¨ ${a.start} çš„åŠ èª² (${a.ts}~${a.te})`);
                    }
                }
            }
        }

        if (removedCount > 0) {
            alert(`âš ï¸ èª²ç¨‹ç•°å‹•é€šçŸ¥ï¼š\nç”±æ–¼å›ºå®šèª²ç¨‹æ¢å¾©æ­£å¸¸ä¸Šèª²æˆ–æ™‚é–“è®Šæ›´ï¼Œç³»çµ±å·²è‡ªå‹•ç§»é™¤ ${removedCount} ç­†è¡çªçš„å€‹åˆ¥åŠ èª²ï¼š\n\n${removedDetails.join('\n')}`); 
            save(); 
            renderCal(); 
        }
    }

    function addAdj(target, type, valId, btnId) {
        let val = document.getElementById(valId).value; if(!val) return alert("è«‹é¸æ“‡æ—¥æœŸ"); 
        let parts = val.replace(/ (è‡³|åˆ°) /g, "~").split("~");
        let start = parts[0].trim(), end = (parts[1]||parts[0]).trim();
        let ts = (type==='extra') ? document.getElementById('exTs').value : null;
        let te = (type==='extra') ? document.getElementById('exTe').value : null;
        let r = (type==='extra') ? document.getElementById('exRate').value : null;
        let reason = (target === 'ALL') ? document.getElementById('allReason').value : "";
        if (target === 'ALL' && !reason.trim()) return alert("è«‹å¡«å¯«åŸå› ï¼"); 
        
        if (type === 'extra' && (r === "" || r === null)) return alert("è«‹å¡«å¯«åŠ èª²è²»ç”¨ï¼"); 

        let conflict = checkAdjConflict(target, type, start, end, ts, te);
        if (conflict) return alert(`ğŸš« ç„¡æ³•æ–°å¢ï¼š${conflict.msg}`); 
        
        adjs.push({ target, type, start, end, ts, te, r, reason, createdAt: Date.now() });
        
        if (target === 'ALL') revalidateAndCleanExtras();

        save(); renderAdj(); 
        
        alert(target === 'ALL' ? "å·²æˆåŠŸè¨­å®šå…¨é«”åœèª²ï¼" : "å·²æˆåŠŸæ–°å¢åŠ èª²ï¼"); 

        document.getElementById(btnId).innerText="ğŸ“… é»æ“Šé¸æ“‡æ—¥æœŸ..."; 
        document.getElementById('allReason').value = ""; 
        
        if (target !== 'ALL') {
            let s = ss.find(x => x.n === target);
            if(s) {
                document.getElementById('exRate').value = s.r;
                document.getElementById('exTs').value = s.ts; 
                document.getElementById('exTe').value = s.te;
            } else {
                document.getElementById('exTs').value = "14:00"; 
                document.getElementById('exTe').value = "14:50";
            }
        }
        
        fpAll.clear(); fpOne.clear();
        updateTimePreviewMulti('exTs','exTe','exTPreview');
    }

    function openAdjEdit(idx) {
        let a = adjs[idx];
        const s = ss.find(x => x.n === a.target);
        const now = new Date();
        const maxD = new Date(now.getFullYear(), now.getMonth() + 12, 0);
        document.getElementById('adjEditIdx').value = idx;
        document.getElementById('adjEditTarget').innerText = a.target === 'ALL' ? "ğŸ“¢ å…¨é«”åœèª²" : `ğŸ‘¤ ${a.target} (åŠ èª²)`;
        
        fpEdit.set("mode", a.type === 'extra' ? "single" : "range");
        
        let rangeDisplay = (a.start === a.end) ? a.start : (a.start + " ~ " + a.end);
        document.getElementById('adjEditRangeVal').value = rangeDisplay;
        document.getElementById('adjEditRangeBtn').innerText = rangeDisplay;

        fpEdit.set("minDate", null);
        fpEdit.set("maxDate", maxD);
        if (a.type === 'extra') {
            document.getElementById('adjEditExtraArea').style.display = 'block';
            document.getElementById('adjEditReasonArea').style.display = 'none';
            document.getElementById('adjEditTs').value = a.ts;
            document.getElementById('adjEditTe').value = a.te;
            document.getElementById('adjEditRate').value = a.r;
            updateTimePreviewMulti('adjEditTs','adjEditTe','adjEditTPreview');
        } else {
            document.getElementById('adjEditExtraArea').style.display = 'none';
            document.getElementById('adjEditReasonArea').style.display = 'block';
            document.getElementById('adjEditReason').value = a.reason;
        }
        document.getElementById('adjModal').style.display = 'flex';
    }

    function saveAdjEdit() {
        let idx = parseInt(document.getElementById('adjEditIdx').value);
        let old = adjs[idx];
        let rangeStr = document.getElementById('adjEditRangeVal').value;
        let parts = rangeStr.replace(/ (è‡³|åˆ°) /g, "~").split("~");
        let start = parts[0].trim(), end = (parts[1]||parts[0]).trim();
        let ts = old.type==='extra'?document.getElementById('adjEditTs').value:null;
        let te = old.type==='extra'?document.getElementById('adjEditTe').value:null;
        let r = old.type==='extra'?document.getElementById('adjEditRate').value:null;
        let reason = old.type!=='extra'?document.getElementById('adjEditReason').value:null;
        
        if (old.type === 'extra' && (r === "" || r === null)) return alert("è«‹å¡«å¯«è²»ç”¨ï¼"); 

        let conflict = checkAdjConflict(old.target, old.type, start, end, ts, te, idx);
        if (conflict) return alert(`ğŸš« ç„¡æ³•ä¿®æ”¹ï¼š${conflict.msg}`); 
        adjs[idx] = { ...old, start, end, ts, te, r, reason };
        
        revalidateAndCleanExtras();

        save(); renderAdj(); renderCal(); closeModal();
    }

    function delAdjFromModal() { let idx = parseInt(document.getElementById('adjEditIdx').value); delAdjItem(idx); closeModal(); }

    function delAdjItem(idx) {
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨­å®šï¼Ÿ')) return; 
        adjs.splice(idx, 1);
        revalidateAndCleanExtras();
        save(); renderAdj(); renderCal();
    }

    function renderAdj(resetFilter = false) {
        const filterEl = document.getElementById('filterStudent');
        if (resetFilter) {
            let optionsHtml = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
            filterEl.innerHTML = optionsHtml;
            if (!filterEl.value || filterEl.value === "ALL") { if (ss.length > 0) filterEl.value = ss[0].n; }
        }
        let filterName = filterEl.value;
        let sorted = [...adjs].sort((a, b) => b.start.localeCompare(a.start));
        
        let allHtml = sorted.filter(a => a.target === 'ALL').map(a => {
            let realIdx = adjs.indexOf(a);
            let dateStr = (a.start === a.end) ? a.start : `${a.start} ~ ${a.end}`;
            return `<div class="adj-item"><div><b>ğŸ“¢ å…¨é«”åœèª²</b> [${a.reason||''}]<br>${dateStr}</div>
            <div style="display:flex; gap:5px;"><button onclick="openAdjEdit(${realIdx})" style="width:60px;background:var(--p);font-size:12px;margin:0;padding:6px;">ç·¨è¼¯</button>
            <button onclick="delAdjItem(${realIdx})" style="width:60px;background:var(--d);font-size:12px;margin:0;padding:6px;">åˆªé™¤</button></div></div>`;
        }).join('');

        let oneHtml = sorted.filter(a => a.target === filterName).map(a => {
            let realIdx = adjs.indexOf(a);
            let info = `åŠ èª² ${a.ts||''}~${a.te||''} $${a.r||''}`;
            let dateStr = (a.start === a.end) ? a.start : `${a.start} ~ ${a.end}`;
            return `<div class="adj-item"><div><b>ğŸ‘¤ ${a.target}</b> [${info}]<br>${dateStr}</div>
            <div style="display:flex; gap:5px;"><button onclick="openAdjEdit(${realIdx})" style="width:60px;background:var(--p);font-size:12px;margin:0;padding:6px;">ç·¨è¼¯</button>
            <button onclick="delAdjItem(${realIdx})" style="width:60px;background:var(--d);font-size:12px;margin:0;padding:6px;">åˆªé™¤</button></div></div>`;
        }).join('');
        
        document.getElementById('allAdjList').innerHTML = allHtml || '<p style="color:#999;font-size:12px;">å°šç„¡è¨­å®š</p>';
        document.getElementById('oneAdjList').innerHTML = oneHtml || '<p style="color:#999;font-size:12px;">å°šç„¡è¨­å®š</p>';
    }

    function renderCalFilter() {
        document.getElementById('calFilterArea').innerHTML = ss.map(s => 
            `<div class="month-chip ${calFilterNames.includes(s.n)?'selected':''}" onclick="toggleCalFilter('${s.n}')">${s.n}</div>`
        ).join('');
    }

    function toggleCalFilter(name) {
        if (calFilterNames.includes(name)) {
            calFilterNames = calFilterNames.filter(n => n !== name);
        } else {
            calFilterNames.push(name);
        }
        renderCalFilter();
        renderCal();
    }

    function renderCal() {
        if(cal) cal.destroy();
        let evs = [], now = new Date();
        
        let startBound = new Date(now.getFullYear(), now.getMonth(), 1);
        let endBound = new Date(now.getFullYear(), now.getMonth() + 12, 0); 

        adjs.forEach(a => { if (new Date(a.start) < startBound) startBound = new Date(a.start); });
        
        let d = new Date(startBound);
        
        while(d <= endBound) {
            let dStr = getDStr(d);
            ss.forEach(s => {
                if (calFilterNames.length > 0 && !calFilterNames.includes(s.n)) return;

                let extras = adjs.filter(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
                extras.forEach(extra => {
                    evs.push({ title:`â‡ï¸ ${s.n} ${fmtT(extra.ts)}`, start: dStr+'T'+extra.ts, backgroundColor: '#c6f6d5', borderColor: '#c6f6d5', textColor:'#22543d', extendedProps:{name:s.n, date:dStr, rate:extra.r, ts:extra.ts, te:extra.te, adjIdx: adjs.indexOf(extra), isExtra: true} });
                });

                let lessonInfo = getEffectiveLesson(s.n, dStr);
                
                if (lessonInfo && lessonInfo.status !== 'none') {
                    let finalStatus = lessonInfo.status;
                    let finalTs = lessonInfo.ts;
                    let finalTe = lessonInfo.te;
                    
                    let ex = dayEx[dStr + "_" + s.n];
                    let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end);
                    
                    let finalReason = '';
                    let finalR = s.r; 
                    if (ex && ex.r) finalR = ex.r;
                    else {
                         let curWeekday = d.getDay();
                         if (s.history) {
                             let h = s.history.find(hist => dStr < hist.until);
                             if (h && curWeekday === h.d) finalR = h.r; 
                         }
                      }

                    if (finalStatus === 'global_off') {
                        finalReason = isAllOff ? isAllOff.reason : '';
                        evs.push({ title:`ğŸš« ${s.n} (${finalReason||'å…¨é«”åœèª²'})`, start: dStr, color:'#fbb6ce', textColor:'#702459', extendedProps:{name:s.n, date:dStr, isFixed: true} });
                    } else if (finalStatus === 'off') {
                        finalReason = (ex && ex.reason) ? ex.reason : '';
                        evs.push({ title:`âŒ ${s.n} (${finalReason||'åœèª²'})`, start: dStr, color:'#fed7d7', textColor:'#c53030', extendedProps:{name:s.n, date:dStr, isFixed: true} });
                    } else {
                        evs.push({ title:`ğŸµ ${s.n} ${fmtT(finalTs)}`, start: dStr+'T'+finalTs, backgroundColor: '#bee3f8', borderColor: '#bee3f8', textColor:'#2b6cb0', extendedProps:{name:s.n, date:dStr, rate:finalR, ts:finalTs, te:finalTe, isFixed: true} });
                    }
                }
            });
            d.setDate(d.getDate()+1);
        }
        cal = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView:'dayGridMonth', locale:'zh-tw', events:evs, headerToolbar:{left:'prev,next', center:'title', right:'today'},
            eventContent:(arg)=>({ 
                domNodes:[
                    Object.assign(document.createElement('div'), {
                        innerText:arg.event.title, 
                        style:`font-size:11px; padding:2px; background-color: ${arg.event.backgroundColor || arg.event.borderColor}; color: ${arg.event.textColor}; border-radius: 3px;`
                    })
                ] 
            }),
            eventClick:(info)=>{
                let p = info.event.extendedProps; if(!p || !p.name) return;
                if (p.isExtra) { openAdjEdit(p.adjIdx); } 
                else if (p.isFixed) {
                    curEditName=p.name; 
                    let origDate = p.date;
                    document.getElementById('mOrigDate').value = origDate; 

                    let ex = dayEx[p.date + "_" + p.name] || {};
                    let s = ss.find(x => x.n === p.name);

                    let baseDObj = new Date(p.date);
                    let baseTs = s.ts, baseTe = s.te, baseR = s.r;
                    if (s.history) {
                        let h = s.history.find(hist => p.date < hist.until);
                        if (h && baseDObj.getDay() === h.d) { baseTs = h.ts; baseTe = h.te; baseR = h.r; }
                    }
                    tempNormalValues = { ts: baseTs, te: baseTe, r: baseR }; 

                    let currentTs = (ex.ts) ? ex.ts : baseTs;
                    let currentTe = (ex.te) ? ex.te : baseTe;
                    let currentR = (ex.r) ? ex.r : baseR;
                    
                    let currentReason = ex.reason || "";
                    if (!ex.status || ex.status === 'normal') {
                        currentReason = "";
                    }
                    
                    document.getElementById('mTitle').innerText=p.name; 
                    document.getElementById('mDateDesc').innerText=p.date;
                    
                    document.getElementById('mTs').value = currentTs; 
                    document.getElementById('mTe').value = currentTe; 
                    document.getElementById('mR').value = currentR;
                    document.getElementById('mOffReason').value = currentReason;

                    let d = new Date(p.date);
                    
                    // ä¿®æ”¹é» 3: ä¿®æ”¹æ—¥æ›†é»æ“Šé‚è¼¯ï¼Œå°‡é€±ä¸€è¦–ç‚ºä¸€é€±çš„é–‹å§‹ (é€±ä¸€~é€±æ—¥)
                    let currentDay = d.getDay(); // 0(Sun) - 6(Sat)
                    // å°‡é€±æ—¥(0)è½‰æ›ç‚º7ï¼Œæ–¹ä¾¿è¨ˆç®—è·é›¢é€±ä¸€çš„å·®è·
                    let dayIndex = currentDay === 0 ? 7 : currentDay;
                    let distanceToMonday = dayIndex - 1; // Mon(1)->0, Tue(2)->1, ..., Sun(7)->6

                    let startOfWeek = new Date(d); 
                    startOfWeek.setDate(d.getDate() - distanceToMonday); // è¨­å®šç‚ºæœ¬é€±ä¸€
                    
                    let endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6); // è¨­å®šç‚ºæœ¬é€±æ—¥

                    fpDateEdit.set("minDate", startOfWeek);
                    fpDateEdit.set("maxDate", endOfWeek);
                    fpDateEdit.jumpToDate(d);
                    fpDateEdit.setDate(d); 
                    document.getElementById('mDateVal').value = p.date;
                    document.getElementById('mDateBtn').innerText = p.date;

                    let statusSelect = document.getElementById('mStatus');
                    let savedStatus = ex.status || 'normal'; 
                    let isGlobalOff = adjs.find(a => a.target === 'ALL' && p.date >= a.start && p.date <= a.end);

                    if (isGlobalOff) {
                         statusSelect.innerHTML = '<option value="global_off">â›” å…¨é«”åœèª²</option>';
                         statusSelect.value = 'global_off';
                    } else {
                         statusSelect.innerHTML = '<option value="normal">ğŸ”µ æ­£å¸¸ä¸Šèª²</option><option value="off">ğŸ”´ åœèª²</option>';
                         statusSelect.value = (savedStatus === 'global_off') ? 'normal' : savedStatus;
                    }

                    updateDayModalUI(false); 

                    onTimeChange(false, 'mTs', 'mTe', 'mTPreview');
                    document.getElementById('dayModal').style.display='flex';
                }
            }
        });
        cal.render();
    }

    function updateDayModalUI(isDateChanged) {
        let currentDateStr = document.getElementById('mDateVal').value;
        let isGlobalOff = adjs.find(a => a.target === 'ALL' && currentDateStr >= a.start && currentDateStr <= a.end);
        let statusSelect = document.getElementById('mStatus');
        let reasonArea = document.getElementById('mOffReasonArea');
        let reasonInput = document.getElementById('mOffReason');
        
        let tsInput = document.getElementById('mTs');
        let teInput = document.getElementById('mTe');
        let rInput = document.getElementById('mR');

        if (isGlobalOff) {
            if (statusSelect.value !== 'global_off') {
                statusSelect.innerHTML = '<option value="global_off">â›” å…¨é«”åœèª²</option>';
                statusSelect.value = 'global_off';
            }
            statusSelect.disabled = true; 
                        
            reasonArea.style.display = 'block';
            reasonInput.value = isGlobalOff.reason;
            reasonInput.disabled = true;

            tsInput.disabled = false;
            teInput.disabled = false;
            rInput.disabled = false;

        } else {
            if (statusSelect.value === 'global_off' || statusSelect.options.length === 1) {
                 statusSelect.innerHTML = '<option value="normal">ğŸ”µ æ­£å¸¸ä¸Šèª²</option><option value="off">ğŸ”´ åœèª²</option>';
                 statusSelect.value = 'normal';
                 reasonInput.value = ""; 
            }
            statusSelect.disabled = false; 

            let currentStatus = statusSelect.value;
                        
            if (currentStatus === 'off') { 
                reasonArea.style.display = 'block';
                reasonInput.disabled = false; 
                                
                if (tsInput.value === "") tsInput.value = tempNormalValues.ts;
                if (teInput.value === "") teInput.value = tempNormalValues.te;
                if (rInput.value === "") rInput.value = tempNormalValues.r;
                
                tsInput.disabled = false;
                teInput.disabled = false;
                rInput.disabled = false;

            } else { 
                reasonArea.style.display = 'none';
                                
                tsInput.disabled = false;
                teInput.disabled = false;
                rInput.disabled = false;
            }
        }
        onTimeChange(false, 'mTs', 'mTe', 'mTPreview');
    }

    function saveDayEx() { 
        let statusSelect = document.getElementById('mStatus');
        let status = statusSelect.value;
        if (status === 'global_off') status = 'normal';

        let reason = document.getElementById('mOffReason').value;
        let ts = document.getElementById('mTs').value, te = document.getElementById('mTe').value, r = document.getElementById('mR').value;
        let newDateStr = document.getElementById('mDateVal').value;
        let origDateStr = document.getElementById('mOrigDate').value;
                
        if (status === 'off' && !reason.trim()) return alert("è«‹è¼¸å…¥åœèª²åŸå› ï¼"); 

        if (newDateStr && newDateStr !== origDateStr) {
            dayEx[origDateStr + "_" + curEditName] = { deleted: true };
            dayEx[newDateStr + "_" + curEditName] = { 
                status: status, ts: ts, te: te, r: r, reason: reason, deleted: false 
            };
        } else {
            dayEx[origDateStr + "_" + curEditName] = { 
                status: status, ts: ts, te: te, r: r, reason: reason, deleted: false 
            };
        }
                
        revalidateAndCleanExtras();

        save(); renderCal(); closeModal(); 
    }

    function upOpt() { let options = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join(''); document.getElementById('bS').innerHTML = options; document.getElementById('oneStudent').innerHTML = options; document.getElementById('filterStudent').innerHTML = options; }
    function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    function share() { window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(document.getElementById('bT').value); }
    function exportData() { const blob = new Blob([JSON.stringify({ss, adjs, dayEx})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `piano_backup.json`; a.click(); }
    function importData() { const input = document.getElementById('importFile'); if(!input.files[0]) return alert("è«‹é¸æ“‡æª”æ¡ˆ"); const reader = new FileReader(); reader.onload = () => { try { const d = JSON.parse(reader.result); ss=d.ss||[]; adjs=d.adjs||[]; dayEx=d.dayEx||{}; sortSS(); save(); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(input.files[0]); } 
    function clearAllData() { if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } } 

    function initBilling() { selectedMonths=[]; document.getElementById('bB').value=0; document.getElementById('bT').value=""; renderMonthPicker(); let nowStr = getDStr(new Date()).substring(0, 7); toggleMonth(nowStr); }
       
    function renderMonthPicker() {
        let n = document.getElementById('bS').value; if(!n) return;
        let s = ss.find(x => x.n === n); if(!s) return;
        let avMonths = new Set(), now = new Date();
        
        let earliestDate = getStudentStartDate(s);
        
        let studentExtras = adjs.filter(a => a.target === s.n && a.type === 'extra');
        studentExtras.forEach(e => {
            let eDate = new Date(e.start);
            if(eDate < earliestDate) earliestDate = eDate;
        });

        let d = new Date(earliestDate);
        let endBound = new Date(now.getFullYear(), now.getMonth() + 12, 0);
        
        while(d <= endBound) {
            let dStr = getDStr(d);
            
            let isExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr === a.start);
            
            let lessonInfo = getEffectiveLesson(s.n, dStr);
            let hasAnyInfo = (lessonInfo && lessonInfo.status !== 'none');

            if (isExtra || hasAnyInfo) {
                avMonths.add(dStr.substring(0, 7));
            }
            d.setDate(d.getDate() + 1);
        }
        document.getElementById('monthPicker').innerHTML = Array.from(avMonths).sort().map(m => `<div class="month-chip ${selectedMonths.includes(m)?'selected':''}" onclick="toggleMonth('${m}')">${m}</div>`).join('');
        upB();
    }
       
    function toggleMonth(m) { if(selectedMonths.includes(m)) selectedMonths = selectedMonths.filter(x => x !== m); else selectedMonths.push(m); renderMonthPicker(); }
       
    function upB() {
        let n = document.getElementById('bS').value; if(!n || selectedMonths.length === 0) { document.getElementById('bT').value = ""; return; }
        let s = ss.find(x => x.n === n), b = parseInt(document.getElementById('bB').value)||0, tCount=0, tR=0, sCount=0;
        let classLines = [], stopLines = [];

        selectedMonths.sort().forEach(mStr => {
            let d = new Date(mStr + "-01"), mon = d.getMonth(), dayList = [], stopDayList = [];
            while(d.getMonth() === mon) {
                let dStr = getDStr(d);
                let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end), extras = adjs.filter(a => a.target === s.n && a.type === 'extra' && dStr === a.start), ex = dayEx[dStr + "_" + s.n];
                extras.forEach(extra => { tCount++; tR += parseInt(extra.r); dayList.push(`${d.getDate()}æ—¥(åŠ èª² $${parseInt(extra.r).toLocaleString()})`); });
                
                let lessonInfo = getEffectiveLesson(s.n, dStr);
                if (lessonInfo && lessonInfo.status !== 'none') {
                    if (lessonInfo.status === 'normal') {
                        let finalR = s.r; 
                        if (ex && ex.r) finalR = ex.r;
                        else {
                            let curWeekday = d.getDay();
                            if (s.history) {
                                let h = s.history.find(hist => dStr < hist.until);
                                if (h && curWeekday === h.d) finalR = h.r;
                            }
                        }
                        tCount++; tR += parseInt(finalR);
                        dayList.push(`${d.getDate()}æ—¥`);
                    } else if (lessonInfo.status === 'off' || lessonInfo.status === 'global_off') {
                        sCount++;
                        let reason = "";
                        if (lessonInfo.status === 'global_off' && isAllOff) reason = isAllOff.reason;
                        else if (lessonInfo.status === 'off' && ex) reason = ex.reason;
                        stopDayList.push(`${d.getDate()}æ—¥(${reason})`);
                    }
                }
                d.setDate(d.getDate() + 1);
            }
            if(dayList.length > 0) { let mNum = mStr.split('-')[1].replace(/^0+/, ''); classLines.push(`${mNum}æœˆï¼š${dayList.join('ã€')}`); }
            if(stopDayList.length > 0) { let mNum = mStr.split('-')[1].replace(/^0+/, ''); stopLines.push(`${mNum}æœˆï¼š${stopDayList.join('ã€')}`); }
        });
        
        let monthTitle = selectedMonths.map(m => m.split('-')[0] + 'å¹´' + m.split('-')[1].replace(/^0+/, '') + 'æœˆ').join('ã€');
        let stopSection = sCount > 0 ? `\nåœèª²æ—¥æœŸï¼š\n${stopLines.join('\n')}\nå…± ${sCount} å ‚\n` : "";

        document.getElementById('bT').value = `ğŸ¹ é‹¼ç´èª²è²»ç”¨æ˜ç´° - ${s.n}\n------------------------\nä¸Šèª²æœˆä»½ï¼š${monthTitle}\nä¸Šèª²æ—¥æœŸï¼š\n${classLines.join('\n')}\nå…± ${tCount} å ‚\n${stopSection}\nèª²ç¨‹è²»ç”¨ï¼š$${tR.toLocaleString()}\næ•™æè²»ç”¨ï¼š$${b.toLocaleString()}\n------------------------\nç¸½è¨ˆé‡‘é¡ï¼š$${(tR + b).toLocaleString()}\n\nå†éº»ç…©åŒ¯æ¬¾å¾Œé€šçŸ¥ï¼Œè¬è¬ï¼`;
    }

    showP('h');
</script>
</body>
</html>
