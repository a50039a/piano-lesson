<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¼ç´æ•™å­¸ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <style>
        :root { --p: #5a67d8; --s: #48bb78; --d: #f56565; --bg: #f8fafc; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        nav { background: white; display: flex; justify-content: space-around; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        nav div { font-weight: bold; color: #a0aec0; cursor: pointer; padding: 5px 10px; font-size: 14px; }
        nav div.active { color: var(--p); border-bottom: 2px solid var(--p); }
        .page { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .active-p { display: block; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        label { display: block; font-size: 13px; font-weight: bold; margin: 10px 0 5px; color: #4a5568; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--p); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-o { background: white; color: var(--p); border: 1.5px solid var(--p); }
        #calendar { background: white; padding: 10px; border-radius: 15px; height: 70vh; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        .range-btn { background: #edf2f7; color: #2d3748; text-align: center; border: 1.5px solid #e2e8f0; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .adj-item { font-size: 14px; padding: 12px 0; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; line-height: 1.5; }
        .month-chip { display: inline-block; padding: 8px 12px; margin: 4px; border-radius: 20px; border: 1px solid #e2e8f0; cursor: pointer; font-size: 14px; }
        .month-chip.selected { background: var(--p); color: white; border-color: var(--p); }
        .fc-event-title { white-space: normal !important; font-weight: bold !important; font-size: 12px; }
    </style>
</head>
<body>

<nav>
    <div onclick="showP('h',this)" class="active">ğŸ“… æ—¥æ›†</div>
    <div onclick="showP('s',this)">ğŸ‘¥ å­¸ç”Ÿ</div>
    <div onclick="showP('off',this)">ğŸš« åœ/åŠ èª²</div>
    <div onclick="showP('b',this)">ğŸ’° è²»ç”¨</div>
</nav>

<div id="h" class="page active-p">
    <h2 style="text-align:center; color:var(--p); margin: 10px 0;">é‹¼ç´æ•™å­¸ç®¡ç†</h2>
    <div id="calendar"></div>
</div>

<div id="s" class="page">
    <button onclick="openSForm()">+ æ–°å¢å­¸ç”Ÿæª”æ¡ˆ</button>
    <div id="sList" style="margin-top:15px;"></div>
</div>

<div id="off" class="page">
    <div class="card">
        <h3>1. å…¨é«”åœèª²è¨­å®š</h3>
        <label>é¸æ“‡æ™‚é–“ç¯„åœ</label>
        <button id="allRangeBtn" class="range-btn">ğŸ“… é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡...</button>
        <input type="hidden" id="allRangeVal">
        <button class="btn-d" onclick="addAdj('ALL', 'off', 'allRangeVal', 'allRangeBtn')">ç¢ºèªè¨­å®šå…¨é«”åœèª²</button>
    </div>
    <div class="card">
        <h3>2. å€‹åˆ¥ åœèª² / åŠ èª²</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="oneStudent"></select>
        <label>é¸æ“‡æ™‚é–“ç¯„åœ</label>
        <button id="oneRangeBtn" class="range-btn">ğŸ“… é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡...</button>
        <input type="hidden" id="oneRangeVal">
        <label>é¡å‹</label>
        <select id="oneType">
            <option value="off">ğŸ”´ åœèª²</option>
            <option value="extra">ğŸŸ¢ åŠ èª²</option>
        </select>
        <button onclick="addAdj(document.getElementById('oneStudent').value, document.getElementById('oneType').value, 'oneRangeVal', 'oneRangeBtn')">ç¢ºèªè¨­å®š</button>
    </div>
    <div class="card"><h3>ç›®å‰è¨­å®šæ¸…å–®</h3><div id="adjList"></div></div>
</div>

<div id="b" class="page">
    <div class="card">
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="bS" onchange="renderMonthPicker(); upB();"></select>
        <label>é¸æ“‡æœˆä»½ (å¯è¤‡é¸)</label>
        <div id="monthPicker" style="margin-bottom: 10px;"></div>
        <label>æ•™æè²»</label><input type="number" id="bB" value="0" onchange="upB()">
        <textarea id="bT" rows="11" style="margin-top:15px; background:#f8fafc; font-size: 14px;"></textarea>
        <button class="btn-s" onclick="share()">LINE åˆ†äº«æ˜ç´°</button>
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3 id="mTitle">å–®æ—¥èª²ç¨‹å¾®èª¿</h3>
        <p id="mDateDesc" style="font-size:14px; color:#666;"></p>
        <label>ç•¶å¤©æ™‚é–“</label><input type="time" id="mT" step="600">
        <label>ç•¶å¤©è²»ç”¨</label><input type="number" id="mR">
        <button onclick="saveDayEx()">åƒ…ä¿®æ”¹é€™ä¸€å¤©</button>
        <button class="btn-d" onclick="delDayEx()">åˆªé™¤é€™å¤©èª²å ‚</button>
        <button class="btn-o" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<div id="sModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3>å­¸ç”ŸåŸºæœ¬è¨­å®š</h3>
        <input type="hidden" id="eIdx">
        <label>å§“å</label><input type="text" id="sN">
        <label>ä¸Šèª²æ—¥</label>
        <select id="sD"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select>
        <label>æ™‚é–“</label><input type="time" id="sT" step="600">
        <label>è²»ç”¨</label><input type="number" id="sR">
        <button onclick="saveS()">ç¢ºèªå„²å­˜</button>
        <button id="delBtn" class="btn-d" style="display:none;">åˆªé™¤å­¸ç”Ÿ</button>
        <button class="btn-o" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<script>
    let ss = JSON.parse(localStorage.getItem('p_ss')) || [];
    let adjs = JSON.parse(localStorage.getItem('p_adjs')) || [];
    let dayEx = JSON.parse(localStorage.getItem('p_dayEx')) || {};
    let selectedMonths = [];
    let cal, curEditDate, curEditName;

    // Flatpickr åˆå§‹åŒ–
    const fpConfig = { 
        mode: "range", 
        locale: "zh_tw", 
        dateFormat: "Y-m-d",
        onClose: function(dates, str, instance) {
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            instance.element.innerText = str ? str : "ğŸ“… é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡...";
        }
    };
    const fpAll = flatpickr("#allRangeBtn", { ...fpConfig, onChange: (dates, str) => document.getElementById('allRangeVal').value = str });
    const fpOne = flatpickr("#oneRangeBtn", { ...fpConfig, onChange: (dates, str) => document.getElementById('oneRangeVal').value = str });

    function fmtT(t) {
        if(!t) return "";
        let [h, m] = t.split(':');
        return (h >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ') + (h%12||12) + ':' + m;
    }

    function showP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-p'));
        document.getElementById(id).classList.add('active-p');
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id === 'h') renderCal();
        if(id === 's') renderS();
        if(id === 'off') renderAdj();
        if(id === 'b') { upOpt(); renderMonthPicker(); upB(); }
    }

    function save() {
        localStorage.setItem('p_ss', JSON.stringify(ss));
        localStorage.setItem('p_adjs', JSON.stringify(adjs));
        localStorage.setItem('p_dayEx', JSON.stringify(dayEx));
    }

    function renderS() {
        document.getElementById('sList').innerHTML = ss.map((s, i) => `
            <div class="card">
                <b>${s.n}</b> | é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.t)} ($${s.r})
                <button onclick="openSForm(${i})" class="btn-o">ä¿®æ”¹è¨­å®š</button>
            </div>
        `).join('');
    }

    function openSForm(i) {
        document.getElementById('sModal').style.display = 'flex';
        const dBtn = document.getElementById('delBtn');
        if(i != null) {
            document.getElementById('eIdx').value = i;
            document.getElementById('sN').value = ss[i].n;
            document.getElementById('sD').value = ss[i].d;
            document.getElementById('sT').value = ss[i].t;
            document.getElementById('sR').value = ss[i].r;
            dBtn.style.display = 'block';
            dBtn.onclick = () => { if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${ss[i].n}ã€ï¼Ÿ`)) { ss.splice(i,1); save(); renderS(); closeModal(); } };
        } else {
            document.getElementById('eIdx').value = ""; document.getElementById('sN').value = ""; document.getElementById('sT').value = "14:00"; dBtn.style.display = 'none';
        }
    }

    function saveS() {
        const today = new Date().toISOString().split('T')[0];
        let i = document.getElementById('eIdx').value;
        let newData = { n: document.getElementById('sN').value, d: parseInt(document.getElementById('sD').value), t: document.getElementById('sT').value, r: document.getElementById('sR').value };
        if(i==="") { ss.push(newData); } else {
            if(!ss[i].history) ss[i].history = [];
            if(ss[i].t !== newData.t || ss[i].r !== newData.r || ss[i].d !== newData.d) {
                ss[i].history.push({ d: ss[i].d, t: ss[i].t, r: ss[i].r, until: today });
            }
            ss[i].n = newData.n; ss[i].d = newData.d; ss[i].t = newData.t; ss[i].r = newData.r;
        }
        save(); renderS(); closeModal();
    }

    function addAdj(target, type, valId, btnId) {
        let val = document.getElementById(valId).value;
        if(!val) return alert("è«‹å…ˆé¸æ“‡æ—¥æœŸç¯„åœ");
        let parts = val.split(" åˆ° ");
        let s = parts[0], e = parts[1] ? parts[1] : s;
        adjs.push({ target, type, start: s, end: e });
        save(); renderAdj();
        // é‡ç½®
        document.getElementById(valId).value = "";
        document.getElementById(btnId).innerText = "ğŸ“… é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡...";
        fpAll.clear(); fpOne.clear();
    }

    function renderAdj() {
        document.getElementById('oneStudent').innerHTML = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
        document.getElementById('adjList').innerHTML = adjs.map((a, i) => `
            <div class="adj-item">
                <div>
                    <b>${a.target === 'ALL' ? 'ğŸ“¢ å…¨é«”åœèª²' : 'ğŸ‘¤ ' + a.target}</b><br>
                    ${a.start} ~ ${a.end} [${a.type==='off'?'åœèª²':'åŠ èª²'}]
                </div>
                <button onclick="if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){adjs.splice(${i},1);save();renderAdj();}" style="width:60px; background:var(--d); font-size:12px; margin:0; padding:6px;">åˆªé™¤</button>
            </div>
        `).join('');
    }

    function getStudentInfoForDate(student, dateStr) {
        if(student.history) {
            let hist = [...student.history].sort((a,b) => b.until.localeCompare(a.until)).find(h => dateStr < h.until);
            if(hist) return hist;
        }
        return student;
    }

    function renderCal() {
        let el = document.getElementById('calendar');
        if(cal) cal.destroy();
        let evs = [];
        let now = new Date();
        let startBound = new Date(now.getFullYear(), 0, 1);
        let endBound = new Date(now.getFullYear(), now.getMonth() + 4, 0);

        ss.forEach(s => {
            let d = new Date(startBound);
            while(d <= endBound) {
                let dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                let info = getStudentInfoForDate(s, dStr);
                let isAllOff = adjs.some(a => a.target === 'ALL' && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isOneExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
                let ex = dayEx[dStr + "_" + s.n];

                if (!(ex && ex.deleted) && ((d.getDay() == info.d && !isAllOff && !isOneOff) || isOneExtra)) {
                    let time = ex ? ex.t : info.t;
                    evs.push({
                        title: `${s.n} ${fmtT(time)}`,
                        start: dStr + 'T' + time,
                        color: isOneExtra ? '#c6f6d5' : '#ebf8ff',
                        textColor: isOneExtra ? '#22543d' : '#2b6cb0',
                        extendedProps: { name: s.n, date: dStr, rate: ex ? ex.r : info.r, time: time }
                    });
                } else if (d.getDay() == info.d && (isAllOff || isOneOff)) {
                    evs.push({ title: `âŒ ${s.n} åœèª²`, start: dStr, color: '#fed7d7', textColor: '#c53030' });
                }
                d.setDate(d.getDate() + 1);
            }
        });

        cal = new FullCalendar.Calendar(el, {
            initialView: 'dayGridMonth',
            events: evs,
            locale: 'zh-tw',
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            eventContent: function(arg) {
                let italicEl = document.createElement('div');
                italicEl.innerText = arg.event.title;
                italicEl.style.fontSize = '12px';
                italicEl.style.padding = '2px';
                return { domNodes: [italicEl] };
            },
            eventClick: function(info) {
                if(info.event.title.includes('åœèª²')) return;
                let p = info.event.extendedProps;
                curEditDate = p.date; curEditName = p.name;
                document.getElementById('mTitle').innerText = p.name;
                document.getElementById('mDateDesc').innerText = p.date;
                document.getElementById('mT').value = p.time;
                document.getElementById('mR').value = p.rate;
                document.getElementById('dayModal').style.display = 'flex';
            }
        });
        cal.render();
    }

    function saveDayEx() {
        dayEx[curEditDate + "_" + curEditName] = { t: document.getElementById('mT').value, r: document.getElementById('mR').value, deleted: false };
        save(); renderCal(); closeModal();
    }

    function delDayEx() {
        if(confirm(`åˆªé™¤ ${curEditDate} èª²ç¨‹ï¼Ÿ`)) {
            dayEx[curEditDate + "_" + curEditName] = { deleted: true };
            save(); renderCal(); closeModal();
        }
    }

    function upOpt() {
        const studentDropdowns = ['bS', 'oneStudent'];
        studentDropdowns.forEach(id => {
            document.getElementById(id).innerHTML = ss.map((s,i) => `<option value="${s.n}">${s.n}</option>`).join('');
        });
    }

    function renderMonthPicker() {
        let n = document.getElementById('bS').value; if(!n) return;
        let s = ss.find(x => x.n === n);
        let availableMonths = new Set(), now = new Date();
        let start = new Date(now.getFullYear(), 0, 1), end = new Date(now.getFullYear(), now.getMonth() + 4, 0);
        let d = new Date(start);
        while(d <= end) {
            let dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            let info = getStudentInfoForDate(s, dStr);
            let isAllOff = adjs.some(a => a.target === 'ALL' && a.type === 'off' && dStr >= a.start && dStr <= a.end);
            let isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end);
            let isOneExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
            let ex = dayEx[dStr + "_" + s.n];
            if (!(ex && ex.deleted) && ((d.getDay() == info.d && !isAllOff && !isOneOff) || isOneExtra)) {
                availableMonths.add(dStr.substring(0, 7));
            }
            d.setDate(d.getDate() + 1);
        }
        let sorted = Array.from(availableMonths).sort();
        document.getElementById('monthPicker').innerHTML = sorted.map(m => `<div class="month-chip ${selectedMonths.includes(m)?'selected':''}" onclick="toggleMonth('${m}')">${m}</div>`).join('');
    }

    function toggleMonth(m) {
        if(selectedMonths.includes(m)) selectedMonths = selectedMonths.filter(x => x !== m);
        else selectedMonths.push(m);
        renderMonthPicker(); upB();
    }

    function upB() {
        let n = document.getElementById('bS').value; if(!n || selectedMonths.length === 0) { document.getElementById('bT').value = ""; return; }
        let s = ss.find(x => x.n === n), b = parseInt(document.getElementById('bB').value)||0, totalCount = 0, totalR = 0, allDates = [];
        selectedMonths.sort().forEach(mStr => {
            let d = new Date(mStr + "-01"), mon = d.getMonth(), monthDates = [];
            while(d.getMonth() === mon) {
                let dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                let info = getStudentInfoForDate(s, dStr);
                let isAllOff = adjs.some(a => a.target === 'ALL' && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isOneExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
                let ex = dayEx[dStr + "_" + s.n];
                if (!(ex && ex.deleted) && ((d.getDay() == info.d && !isAllOff && !isOneOff) || isOneExtra)) {
                    totalCount++; totalR += parseInt(ex ? ex.r : info.r); monthDates.push(d.getDate());
                }
                d.setDate(d.getDate() + 1);
            }
            allDates.push(`${mStr.split('-')[1]}æœˆ(${monthDates.join(',')})`);
        });
        let monthTitle = selectedMonths.map(m => m.replace('-','å¹´')+'æœˆ').join('ã€');
        document.getElementById('bT').value = `ğŸ¹ è²»ç”¨æ˜ç´° - ${s.n}\n------------------------\næœˆä»½ï¼š${monthTitle}\nä¸Šèª²æ—¥æœŸï¼š\n${allDates.join('\n')}\nå…± ${totalCount} å ‚\n\nèª²ç¨‹è²»ç”¨ï¼š$${totalR.toLocaleString()}\næ•™æè²»ç”¨ï¼š$${b.toLocaleString()}\n------------------------\nç¸½è¨ˆé‡‘é¡ï¼š$${(totalR + b).toLocaleString()}\n\nå†éº»ç…©åŒ¯æ¬¾å¾Œé€šçŸ¥ï¼Œè¬è¬ï¼`;
    }

    function share() { window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(document.getElementById('bT').value); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    showP('h');
</script>
</body>
</html>
