<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¼ç´æ•™å­¸ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <style>
        :root { --p: #5a67d8; --s: #48bb78; --d: #f56565; --bg: #f8fafc; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        nav { background: white; display: flex; justify-content: space-around; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        nav div { font-weight: bold; color: #a0aec0; cursor: pointer; padding: 5px 10px; font-size: 14px; }
        nav div.active { color: var(--p); border-bottom: 2px solid var(--p); }
        .page { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .active-p { display: block; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        label { display: block; font-size: 13px; font-weight: bold; margin: 10px 0 5px; color: #4a5568; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .time-row { display: flex; gap: 10px; align-items: center; }
        .time-preview { font-size: 13px; color: var(--p); font-weight: bold; margin-bottom: 5px; }
        button { background: var(--p); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-o { background: white; color: var(--p); border: 1.5px solid var(--p); }
        #calendar { background: white; padding: 10px; border-radius: 15px; height: 70vh; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        .range-btn { background: #edf2f7; color: #2d3748; text-align: center; border: 1.5px solid #e2e8f0; min-height: 45px; display: flex; align-items: center; justify-content: center; width: 100%; border-radius: 10px; }
        .adj-item { font-size: 14px; padding: 12px 0; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
        .month-chip { display: inline-block; padding: 10px 15px; margin: 5px; border-radius: 10px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .month-chip.selected { background: var(--p); color: white; border-color: var(--p); }
    </style>
</head>
<body>

<nav>
    <div onclick="showP('h',this)" class="active">ğŸ“… æ—¥æ›†</div>
    <div onclick="showP('s',this)">ğŸ‘¥ å­¸ç”Ÿ</div>
    <div onclick="showP('off',this)">ğŸš« åœ/åŠ èª²</div>
    <div onclick="showP('b',this)">ğŸ’° è²»ç”¨</div>
</nav>

<div id="h" class="page active-p">
    <div id="calendar"></div>
</div>

<div id="s" class="page">
    <button onclick="openSForm()">+ æ–°å¢å­¸ç”Ÿæª”æ¡ˆ</button>
    <div id="sList" style="margin-top:15px;"></div>
</div>

<div id="off" class="page">
    <div class="card">
        <h3>ğŸ“¢ å…¨é«”åœèª²</h3>
        <button id="allRangeBtn" class="range-btn">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="allRangeVal">
        <label>åŸå› </label><input type="text" id="allReason" placeholder="ä¾‹ï¼šè€å¸«è«‹å‡">
        <button class="btn-d" style="margin-top:10px;" onclick="addAdj('ALL', 'off', 'allRangeVal', 'allRangeBtn')">ç¢ºèªå…¨é«”åœèª²</button>
    </div>
    <div class="card">
        <h3>ğŸ‘¤ å€‹åˆ¥åœ/åŠ èª²</h3>
        <label>é¸æ“‡å­¸ç”Ÿ</label><select id="oneStudent" onchange="updateExRateHint()"></select>
        <button id="oneRangeBtn" class="range-btn">ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ...</button>
        <input type="hidden" id="oneRangeVal">
        <label>é¡å‹</label>
        <select id="oneType" onchange="toggleAdjFields(this.value)">
            <option value="off">ğŸ”´ åœèª²</option>
            <option value="extra">ğŸŸ¢ åŠ èª²</option>
        </select>
        
        <div id="adjReasonArea">
            <label>åœèª²åŸå› </label>
            <input type="text" id="adjReason" placeholder="ä¾‹ï¼šæ„Ÿå†’è«‹å‡">
        </div>

        <div id="extraTimeArea" style="display:none;">
            <label>åŠ èª²æ™‚æ®µ</label>
            <div class="time-row">
                <input type="time" id="exTs" value="12:00" oninput="updateTimePreviewMulti('exTs','exTe','exTPreview')">
                <span>è‡³</span>
                <input type="time" id="exTe" value="12:50" oninput="updateTimePreviewMulti('exTs','exTe','exTPreview')">
            </div>
            <div id="exTPreview" class="time-preview"></div>
            <label>å–®æ¬¡åŠ èª²è²»ç”¨</label>
            <input type="number" id="exRate" placeholder="é è¨­ä½¿ç”¨åŸºæœ¬å­¸è²»">
        </div>
        <button style="margin-top:10px;" onclick="addAdj(document.getElementById('oneStudent').value, document.getElementById('oneType').value, 'oneRangeVal', 'oneRangeBtn')">ç¢ºèªè¨­å®š</button>
    </div>
    <div class="card"><h3>ç›®å‰è¨­å®šæ¸…å–®</h3><div id="adjList"></div></div>
</div>

<div id="b" class="page">
    <div class="card">
        <label>å°è±¡</label><select id="bS" onchange="initBilling()"></select>
        <label>æœˆä»½ (å¤šé¸)</label><div id="monthPicker"></div>
        <label>æ•™æè²»</label><input type="number" id="bB" value="0" onchange="upB()">
        <textarea id="bT" rows="11" style="margin-top:15px; background:#f8fafc; font-size: 14px; border:none;"></textarea>
        <button class="btn-s" style="margin-top:10px;" onclick="share()">LINE åˆ†äº«æ˜ç´°</button>
    </div>
</div>

<div id="sModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3>å­¸ç”Ÿè³‡æ–™</h3>
        <input type="hidden" id="eIdx">
        <label>å§“å</label><input type="text" id="sN">
        <label>é€±å¹¾</label><select id="sD"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select>
        <label>ä¸Šèª²æ™‚æ®µ</label>
        <div class="time-row"><input type="time" id="sTs"><span>~</span><input type="time" id="sTe"></div>
        <div id="sTPreview" class="time-preview"></div>
        <label>å­¸è²»</label><input type="number" id="sR">
        <button onclick="saveS()">å„²å­˜</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="card" style="width:90%; max-width:350px;">
        <h3 id="mTitle"></h3>
        <p id="mDateDesc" style="color: #5a67d8; font-weight: bold;"></p>
        <input type="hidden" id="mAdjIdx">
        <label>ç•¶å¤©æ™‚æ®µ</label>
        <div class="time-row"><input type="time" id="mTs"><span>~</span><input type="time" id="mTe"></div>
        <div id="mTPreview" class="time-preview"></div>
        <label>å­¸è²»</label><input type="number" id="mR">
        <button onclick="saveDayEx()">å„²å­˜ä¿®æ”¹</button>
        <button class="btn-d" style="margin-top:10px;" onclick="delDayEx()">åˆªé™¤é€™èª²å ‚</button>
        <button class="btn-o" style="margin-top:10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let ss = JSON.parse(localStorage.getItem('p_ss')) || [];
    let adjs = JSON.parse(localStorage.getItem('p_adjs')) || [];
    let dayEx = JSON.parse(localStorage.getItem('p_dayEx')) || {};
    let selectedMonths = [], cal, curEditDate, curEditName;

    function fmtT(t) { if(!t) return ""; let [h,m] = t.split(':'); return (h>=12?'ä¸‹åˆ':'ä¸Šåˆ')+(h%12||12)+':'+m; }
    function updateTimePreviewMulti(sid, eid, target) {
        let s = document.getElementById(sid).value, e = document.getElementById(eid).value;
        document.getElementById(target).innerText = (s && e) ? `ç¢ºèªæ™‚æ®µï¼š${fmtT(s)} ~ ${fmtT(e)}` : "";
    }

    const fpConfig = { 
        mode: "range", locale: "zh_tw", dateFormat: "Y-m-d",
        onClose: function(dates, str, instance) { instance.element.innerText = str.replace(/ (è‡³|åˆ°) /g, " ~ ") || "ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ..."; }
    };
    const fpAll = flatpickr("#allRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('allRangeVal').value = str });
    const fpOne = flatpickr("#oneRangeBtn", { ...fpConfig, onChange: (d, str) => document.getElementById('oneRangeVal').value = str });

    function showP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-p'));
        document.getElementById(id).classList.add('active-p');
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id === 'h') renderCal();
        if(id === 's') renderS();
        if(id === 'off') { renderAdj(); updateExRateHint(); }
        if(id === 'b') initBilling();
    }

    function save() {
        localStorage.setItem('p_ss', JSON.stringify(ss));
        localStorage.setItem('p_adjs', JSON.stringify(adjs));
        localStorage.setItem('p_dayEx', JSON.stringify(dayEx));
    }

    function renderS() {
        document.getElementById('sList').innerHTML = ss.map((s, i) => `
            <div class="card"><b>${s.n}</b> | é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][s.d]} ${fmtT(s.ts)}~${fmtT(s.te)} ($${s.r})
            <div style="display:flex; gap:8px; margin-top:10px;"><button class="btn-o" style="flex:1;" onclick="openSForm(${i})">ä¿®æ”¹è³‡æ–™</button>
            <button class="btn-d" style="flex:1;" onclick="if(confirm('åˆªé™¤å­¸ç”Ÿï¼Ÿ')){ss.splice(${i},1);save();renderS();}">åˆªé™¤</button></div></div>`).join('');
    }

    function openSForm(i) {
        document.getElementById('sModal').style.display='flex';
        if(i!=null) {
            let s = ss[i]; document.getElementById('eIdx').value=i; document.getElementById('sN').value=s.n;
            document.getElementById('sD').value=s.d; document.getElementById('sTs').value=s.ts; document.getElementById('sTe').value=s.te; document.getElementById('sR').value=s.r;
        } else {
            document.getElementById('eIdx').value=""; document.getElementById('sN').value=""; document.getElementById('sTs').value="14:00"; document.getElementById('sTe').value="15:00";
        }
        updateTimePreviewMulti('sTs','sTe','sTPreview');
    }

    function saveS() {
        let i = document.getElementById('eIdx').value, data = { n: document.getElementById('sN').value, d: parseInt(document.getElementById('sD').value), ts: document.getElementById('sTs').value, te: document.getElementById('sTe').value, r: document.getElementById('sR').value };
        if(i==="") ss.push(data); else ss[i]={...ss[i], ...data};
        save(); renderS(); closeModal();
    }

    function toggleAdjFields(v) { 
        document.getElementById('extraTimeArea').style.display = v==='extra'?'block':'none'; 
        document.getElementById('adjReasonArea').style.display = v==='off'?'block':'none'; 
        updateExRateHint();
    }

    function updateExRateHint() {
        let name = document.getElementById('oneStudent').value;
        let s = ss.find(x => x.n === name);
        if(s) document.getElementById('exRate').placeholder = `é è¨­ï¼š$${s.r}`;
        updateTimePreviewMulti('exTs','exTe','exTPreview');
    }

    function addAdj(target, type, valId, btnId) {
        let val = document.getElementById(valId).value; if(!val) return alert("è«‹é¸æ“‡ç¯„åœ");
        let parts = val.replace(/ (è‡³|åˆ°) /g, "~").split("~");
        let start = parts[0].trim(), end = (parts[1]||parts[0]).trim();
        let r = (type === 'extra' && document.getElementById('exRate').value) ? document.getElementById('exRate').value : null;
        let reason = (type === 'off' || target === 'ALL') ? (target === 'ALL' ? document.getElementById('allReason').value : document.getElementById('adjReason').value) : "";

        adjs.push({ 
            target, type, start, end,
            ts: type==='extra'?document.getElementById('exTs').value:null, 
            te: type==='extra'?document.getElementById('exTe').value:null, 
            r, reason 
        });
        save(); renderAdj(); 
        document.getElementById(btnId).innerText="ğŸ“… é»æ“Šé¸æ“‡ç¯„åœ..."; 
        document.getElementById('allReason').value = ""; document.getElementById('adjReason').value = ""; document.getElementById('exRate').value = "";
        fpAll.clear(); fpOne.clear();
    }

    function renderAdj() {
        document.getElementById('oneStudent').innerHTML = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
        document.getElementById('adjList').innerHTML = adjs.map((a, i) => {
            let info = "";
            if(a.target==='ALL') info = 'å…¨é«”åœèª²'+(a.reason?':'+a.reason:'');
            else if(a.type==='off') info = 'åœèª²'+(a.reason?':'+a.reason:'');
            else info = `åŠ èª² ${a.ts||''}~${a.te||''} ${a.r?'$'+a.r:''}`;
            return `<div class="adj-item"><div><b>${a.target==='ALL'?'ğŸ“¢ å…¨é«”':a.target}</b><br>${a.start} ~ ${a.end} [${info}]</div>
            <button onclick="if(confirm('åˆªé™¤ï¼Ÿ')){adjs.splice(${i},1);save();renderAdj();renderCal();}" style="width:60px;background:var(--d);font-size:12px;margin:0;padding:6px;">åˆªé™¤</button></div>`;
        }).join('');
    }

    function renderCal() {
        if(cal) cal.destroy();
        let evs = [], now = new Date(), startBound = new Date(now.getFullYear(), 0, 1), endBound = new Date(now.getFullYear(), now.getMonth() + 4, 0);
        
        // éæ­·ç•¶å‰æ¸²æŸ“ç¯„åœå…§çš„æ¯ä¸€å¤©
        let dCursor = new Date(startBound);
        while(dCursor <= endBound) {
            let dStr = dCursor.toISOString().split('T')[0];
            
            ss.forEach(s => {
                // å„ªå…ˆæ¬Š 1: æª¢æŸ¥é€™å¤©æ˜¯å¦æœ‰å€‹åˆ¥åŠ èª² (åŠ èª²ä¸é™åŸæœ¬æ˜¯é€±å¹¾)
                let adjIdx = adjs.findIndex(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end);
                let isExtra = adjIdx !== -1 ? adjs[adjIdx] : null;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰åœèª² (å…¨é«”æˆ–å€‹åˆ¥)
                let isOneOff = adjs.find(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end);
                let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å–®æ—¥å¾®èª¿æˆ–åˆªé™¤
                let ex = dayEx[dStr + "_" + s.n];

                if (!(ex && ex.deleted)) {
                    if (isExtra) {
                        // ğŸŸ¢ åŠ èª²é‚è¼¯ï¼šåªè¦è¨­å®šäº†åŠ èª²ï¼Œä¸è«–é€±å¹¾éƒ½ç•«å‡ºä¾†
                        let ts = ex ? ex.ts : (isExtra.ts || s.ts), te = ex ? ex.te : (isExtra.te || s.te);
                        evs.push({ 
                            title: `â­ ${s.n} ${fmtT(ts)}~${fmtT(te)}`, 
                            start: dStr + 'T' + ts, 
                            color: '#c6f6d5', 
                            textColor: '#22543d', 
                            extendedProps: { name: s.n, date: dStr, rate: ex ? ex.r : (isExtra.r || s.r), ts, te, adjIdx } 
                        });
                    } else if (dCursor.getDay() == s.d) {
                        // ğŸ”µ å¸¸è¦èª²é‚è¼¯ï¼šåƒ…åœ¨å­¸ç”Ÿçš„ä¸Šèª²æ—¥æª¢æŸ¥
                        if (isOneOff) {
                            evs.push({ title: `âŒ åœèª²:${isOneOff.reason || ''} (${s.n})`, start: dStr, color: '#fed7d7', textColor: '#c53030' });
                        } else if (isAllOff) {
                            evs.push({ title: `ğŸš« å…¨é«”åœèª²:${isAllOff.reason || ''} (${s.n})`, start: dStr, color: '#fbb6ce', textColor: '#702459' });
                        } else {
                            let ts = ex ? ex.ts : s.ts, te = ex ? ex.te : s.te;
                            evs.push({ 
                                title: `${s.n} ${fmtT(ts)}~${fmtT(te)}`, 
                                start: dStr + 'T' + ts, 
                                color: '#ebf8ff', 
                                textColor: '#2b6cb0', 
                                extendedProps: { name: s.n, date: dStr, rate: ex ? ex.r : s.r, ts, te, adjIdx: -1 } 
                            });
                        }
                    }
                }
            });
            dCursor.setDate(dCursor.getDate() + 1);
        }

        cal = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth', locale: 'zh-tw', events: evs, headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            eventContent: (arg) => ({ domNodes: [Object.assign(document.createElement('div'), { innerText: arg.event.title, style: 'font-size:11px;padding:2px' })] }),
            eventClick: (info) => {
                let p = info.event.extendedProps; if (!p || !p.name) return;
                curEditDate = p.date; curEditName = p.name;
                document.getElementById('mTitle').innerText = p.name; document.getElementById('mDateDesc').innerText = p.date;
                document.getElementById('mTs').value = p.ts; document.getElementById('mTe').value = p.te; document.getElementById('mR').value = p.rate;
                document.getElementById('mAdjIdx').value = p.adjIdx;
                updateTimePreviewMulti('mTs', 'mTe', 'mTPreview'); document.getElementById('dayModal').style.display = 'flex';
            }
        });
        cal.render();
    }

    function initBilling() { selectedMonths = []; document.getElementById('bB').value = 0; document.getElementById('bT').value = ""; upOpt(); renderMonthPicker(); }
    function renderMonthPicker() {
        let n = document.getElementById('bS').value; if (!n) return;
        let s = ss.find(x => x.n === n), avMonths = new Set(), d = new Date(new Date().getFullYear(), 0, 1), end = new Date(new Date().getFullYear(), new Date().getMonth() + 4, 0);
        while (d <= end) {
            let dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            let isAllOff = adjs.some(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end), isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end), isExtra = adjs.some(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end), ex = dayEx[dStr + "_" + s.n];
            if (!(ex && ex.deleted) && ((d.getDay() == s.d && !isAllOff && !isOneOff) || isExtra)) avMonths.add(dStr.substring(0, 7));
            d.setDate(d.getDate() + 1);
        }
        document.getElementById('monthPicker').innerHTML = Array.from(avMonths).sort().map(m => `<div class="month-chip ${selectedMonths.includes(m) ? 'selected' : ''}" onclick="toggleMonth('${m}')">${m}</div>`).join('');
    }
    function toggleMonth(m) { if (selectedMonths.includes(m)) selectedMonths = selectedMonths.filter(x => x !== m); else selectedMonths.push(m); renderMonthPicker(); upB(); }
    function upB() {
        let n = document.getElementById('bS').value; if (!n || selectedMonths.length === 0) return;
        let s = ss.find(x => x.n === n), b = parseInt(document.getElementById('bB').value) || 0, tCount = 0, tR = 0, allD = [];
        selectedMonths.sort().forEach(mStr => {
            let d = new Date(mStr + "-01"), mon = d.getMonth(), mDates = [];
            while (d.getMonth() === mon) {
                let dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                let isAllOff = adjs.find(a => a.target === 'ALL' && dStr >= a.start && dStr <= a.end), isOneOff = adjs.some(a => a.target === s.n && a.type === 'off' && dStr >= a.start && dStr <= a.end), isExtra = adjs.find(a => a.target === s.n && a.type === 'extra' && dStr >= a.start && dStr <= a.end), ex = dayEx[dStr + "_" + s.n];
                if (!(ex && ex.deleted) && ((d.getDay() == s.d && !isAllOff && !isOneOff) || isExtra)) {
                    tCount++; tR += parseInt(ex ? ex.r : (isExtra && isExtra.r ? isExtra.r : s.r));
                    let ts = ex ? ex.ts : (isExtra ? (isExtra.ts || s.ts) : s.ts), te = ex ? ex.te : (isExtra ? (isExtra.te || s.te) : s.te);
                    mDates.push(`${d.getDate()}æ—¥(${ts}~${te})`);
                }
                d.setDate(d.getDate() + 1);
            }
            allD.push(`${mStr.split('-')[1]}æœˆï¼š${mDates.join('ã€')}`);
        });
        document.getElementById('bT').value = `ğŸ¹ è²»ç”¨æ˜ç´° - ${s.n}\n------------------------\næœˆä»½ï¼š${selectedMonths.map(m => m.replace('-', 'å¹´') + 'æœˆ').join('ã€')}\nä¸Šèª²æ—¥æœŸï¼š\n${allD.join('\n')}\nå…± ${tCount} å ‚\n\nèª²ç¨‹è²»ç”¨ï¼š$${tR.toLocaleString()}\næ•™æè²»ç”¨ï¼š$${b.toLocaleString()}\n------------------------\nç¸½è¨ˆé‡‘é¡ï¼š$${(tR + b).toLocaleString()}\n\nå†éº»ç…©åŒ¯æ¬¾å¾Œé€šçŸ¥ï¼Œè¬è¬ï¼`;
    }
    function saveDayEx() {
        let ts = document.getElementById('mTs').value, te = document.getElementById('mTe').value, r = document.getElementById('mR').value;
        let adjIdx = parseInt(document.getElementById('mAdjIdx').value);
        if (adjIdx !== -1 && adjs[adjIdx]) { adjs[adjIdx].ts = ts; adjs[adjIdx].te = te; adjs[adjIdx].r = r; }
        dayEx[curEditDate + "_" + curEditName] = { ts, te, r, deleted: false }; save(); renderCal(); closeModal();
    }
    function delDayEx() { if (confirm('åˆªé™¤ï¼Ÿ')) { dayEx[curEditDate + "_" + curEditName] = { deleted: true }; save(); renderCal(); closeModal(); } }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function upOpt() { document.getElementById('bS').innerHTML = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join(''); document.getElementById('oneStudent').innerHTML = ss.map(s => `<option value="${s.n}">${s.n}</option>`).join(''); }
    function share() { window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(document.getElementById('bT').value); }
    showP('h');
</script>
</body>
</html>
